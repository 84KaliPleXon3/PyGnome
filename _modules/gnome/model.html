

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gnome.model &mdash; pyGNOME 0.1.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="pyGNOME 0.1.1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> pyGNOME
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installing.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../structure.html">GNOME Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scripting.html">Scripting pygnome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../customizing.html">Customizing pygnome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">The logging system</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../serialization.html">Notes on serialization / deserialization:</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../units.html">Units used in GNOME / PyGNOME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">PyGnome Class Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">pyGNOME</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>gnome.model</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gnome.model</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="kn">from</span> <span class="nn">colander</span> <span class="k">import</span> <span class="p">(</span><span class="n">SchemaNode</span><span class="p">,</span>
                      <span class="n">String</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Bool</span><span class="p">,</span>
                      <span class="n">drop</span><span class="p">,</span> <span class="n">OneOf</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">gnome.environment</span> <span class="k">import</span> <span class="n">Environment</span>

<span class="kn">import</span> <span class="nn">gnome.utilities.cache</span>
<span class="kn">from</span> <span class="nn">gnome.utilities.time_utils</span> <span class="k">import</span> <span class="n">round_time</span>
<span class="kn">from</span> <span class="nn">gnome.utilities.orderedcollection</span> <span class="k">import</span> <span class="n">OrderedCollection</span>
<span class="kn">from</span> <span class="nn">gnome.utilities.serializable</span> <span class="k">import</span> <span class="n">Serializable</span><span class="p">,</span> <span class="n">Field</span>

<span class="kn">from</span> <span class="nn">gnome.basic_types</span> <span class="k">import</span> <span class="n">oil_status</span><span class="p">,</span> <span class="n">fate</span>
<span class="kn">from</span> <span class="nn">gnome.spill_container</span> <span class="k">import</span> <span class="n">SpillContainerPair</span>
<span class="kn">from</span> <span class="nn">gnome.environment</span> <span class="k">import</span> <span class="n">Wind</span>
<span class="kn">from</span> <span class="nn">gnome.movers</span> <span class="k">import</span> <span class="n">Mover</span>
<span class="kn">from</span> <span class="nn">gnome.weatherers</span> <span class="k">import</span> <span class="p">(</span><span class="n">weatherer_sort</span><span class="p">,</span>
                              <span class="n">Weatherer</span><span class="p">,</span>
                              <span class="n">WeatheringData</span><span class="p">,</span>
                              <span class="n">FayGravityViscous</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gnome.outputters</span> <span class="k">import</span> <span class="n">Outputter</span><span class="p">,</span> <span class="n">NetCDFOutput</span><span class="p">,</span> <span class="n">WeatheringOutput</span>
<span class="kn">from</span> <span class="nn">gnome.persist</span> <span class="k">import</span> <span class="p">(</span><span class="n">extend_colander</span><span class="p">,</span>
                           <span class="n">validators</span><span class="p">,</span>
                           <span class="n">References</span><span class="p">,</span>
                           <span class="n">class_from_objtype</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gnome.persist.base_schema</span> <span class="k">import</span> <span class="p">(</span><span class="n">ObjType</span><span class="p">,</span>
                                       <span class="n">CollectionItemsList</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">gnome.exceptions</span> <span class="k">import</span> <span class="n">ReferencedObjectNotSet</span>


<span class="k">class</span> <span class="nc">ModelSchema</span><span class="p">(</span><span class="n">ObjType</span><span class="p">):</span>
    <span class="s1">&#39;Colander schema for Model object&#39;</span>
    <span class="n">time_step</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">weathering_substeps</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">extend_colander</span><span class="o">.</span><span class="n">LocalDateTime</span><span class="p">(),</span>
                            <span class="n">validator</span><span class="o">=</span><span class="n">validators</span><span class="o">.</span><span class="n">convertible_to_seconds</span><span class="p">,</span>
                            <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">extend_colander</span><span class="o">.</span><span class="n">TimeDelta</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">uncertain</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">cache_enabled</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">num_time_steps</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">make_default_refs</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span> <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">SchemaNode</span><span class="p">(</span><span class="n">String</span><span class="p">(),</span>
                      <span class="n">validator</span><span class="o">=</span><span class="n">OneOf</span><span class="p">([</span><span class="s1">&#39;gnome&#39;</span><span class="p">,</span> <span class="s1">&#39;adios&#39;</span><span class="p">,</span> <span class="s1">&#39;roc&#39;</span><span class="p">]),</span>
                      <span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_</span><span class="o">=</span><span class="s1">&#39;webapi&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Add default schema for orderedcollections if oc_schema=True</span>
<span class="sd">        The default schema works for &#39;save&#39; files since it only keeps the same</span>
<span class="sd">        info {&#39;obj_type&#39; and &#39;id&#39;} for all elements in OC. For &#39;webapi&#39;, we</span>
<span class="sd">        cannot do this and must deserialize each element of the collection</span>
<span class="sd">        using the deserialize method of each object; so these are not added to</span>
<span class="sd">        schema for &#39;webapi&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">json_</span> <span class="o">==</span> <span class="s1">&#39;save&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spills&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uncertain_spills&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;movers&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;weatherers&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;environment&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CollectionItemsList</span><span class="p">(</span><span class="n">missing</span><span class="o">=</span><span class="n">drop</span><span class="p">,</span>
                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputters&#39;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ModelSchema</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../reference.html#gnome.model.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">Serializable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    PyGnome Model Class</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_update</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_step&#39;</span><span class="p">,</span>
               <span class="s1">&#39;weathering_substeps&#39;</span><span class="p">,</span>
               <span class="s1">&#39;start_time&#39;</span><span class="p">,</span>
               <span class="s1">&#39;duration&#39;</span><span class="p">,</span>
               <span class="s1">&#39;uncertain&#39;</span><span class="p">,</span>
               <span class="s1">&#39;cache_enabled&#39;</span><span class="p">,</span>
               <span class="s1">&#39;mode&#39;</span><span class="p">,</span>
               <span class="s1">&#39;map&#39;</span><span class="p">,</span>
               <span class="s1">&#39;movers&#39;</span><span class="p">,</span>
               <span class="s1">&#39;weatherers&#39;</span><span class="p">,</span>
               <span class="s1">&#39;environment&#39;</span><span class="p">,</span>
               <span class="s1">&#39;outputters&#39;</span><span class="p">]</span>

    <span class="n">_create</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_create</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_update</span><span class="p">)</span>
    <span class="n">_state</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Serializable</span><span class="o">.</span><span class="n">_state</span><span class="p">)</span>
    <span class="n">_schema</span> <span class="o">=</span> <span class="n">ModelSchema</span>

    <span class="c1"># no need to copy parent&#39;s _state in this case</span>
    <span class="n">_state</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="n">_create</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">_update</span><span class="p">)</span>

    <span class="c1"># override __eq__ since &#39;spills&#39; and &#39;uncertain_spills&#39; need to be checked</span>
    <span class="c1"># They both have _to_dict() methods to return underlying ordered</span>
    <span class="c1"># collections and that would not be the correct way to check equality</span>
    <span class="n">_state</span> <span class="o">+=</span> <span class="p">[</span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;spills&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_for_eq</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
               <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;uncertain_spills&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_for_eq</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
               <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;num_time_steps&#39;</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
               <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;make_default_refs&#39;</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

    <span class="c1"># list of OrderedCollections</span>
    <span class="n">_oc_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;movers&#39;</span><span class="p">,</span> <span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;outputters&#39;</span><span class="p">]</span>

    <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;gnome&#39;</span><span class="p">,</span> <span class="s1">&#39;adios&#39;</span><span class="p">,</span> <span class="s1">&#39;roc&#39;</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Model.new_from_dict"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.new_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">new_from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
        <span class="s1">&#39;Restore model from previously persisted _state&#39;</span>
        <span class="n">json_</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;json_&#39;</span><span class="p">)</span>
        <span class="n">l_env</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">l_out</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;outputters&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">g_objects</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;movers&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">l_weatherers</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">c_spills</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;spills&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="s1">&#39;uncertain_spills&#39;</span> <span class="ow">in</span> <span class="n">dict_</span><span class="p">:</span>
            <span class="n">u_spills</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;uncertain_spills&#39;</span><span class="p">)</span>
            <span class="n">l_spills</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c_spills</span><span class="p">,</span> <span class="n">u_spills</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l_spills</span> <span class="o">=</span> <span class="n">c_spills</span>

        <span class="c1"># define defaults for properties that a location file may not contain</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__init__</span><span class="p">)</span>
        <span class="n">default_restore</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:],</span> <span class="n">kwargs</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">json_</span> <span class="o">==</span> <span class="s1">&#39;webapi&#39;</span><span class="p">:</span>
            <span class="c1"># default is to disable cache</span>
            <span class="n">default_restore</span><span class="p">[</span><span class="s1">&#39;cache_enabled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">default_restore</span><span class="p">:</span>
            <span class="n">default_restore</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_restore</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">__restore__</span><span class="p">(</span><span class="o">**</span><span class="n">default_restore</span><span class="p">)</span>

        <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">l_env</span><span class="p">]</span>
        <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">outputters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">l_out</span><span class="p">]</span>
        <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">l_spills</span><span class="p">]</span>
        <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">movers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">g_objects</span><span class="p">]</span>
        <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">weatherers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">l_weatherers</span><span class="p">]</span>

        <span class="c1"># register callbacks with OrderedCollections after objects are added</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_register_callbacks</span><span class="p">()</span>

        <span class="c1"># OrderedCollections are being used so maintain order.</span>
        <span class="k">if</span> <span class="n">json_</span> <span class="o">==</span> <span class="s1">&#39;webapi&#39;</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">update_from_dict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_restore_attr_from_save</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>

        <span class="c1"># restore the spill data outside this method - let&#39;s not try to find</span>
        <span class="c1"># the saveloc here</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0._pid}</span><span class="s2">&#39;new_from_dict&#39; created new model: &quot;</span>
               <span class="s2">&quot;</span><span class="si">{0.name}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Model.load_savefile"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.load_savefile">[docs]</a>    <span class="k">def</span> <span class="nf">load_savefile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load a model instance from a save file</span>

<span class="sd">        :param filename: the filename of the save file -- usually a zip file,</span>
<span class="sd">                         but can also be a directry with the full contents of</span>
<span class="sd">                         a zip file</span>

<span class="sd">        :returns: a model instance all set up from the savefile.</span>

<span class="sd">        This is simply a utility wrapper around:</span>
<span class="sd">        ``gnome.persist.save_load.load()``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">gnome</span><span class="o">.</span><span class="n">persist</span><span class="o">.</span><span class="n">save_load</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># check that this actually loaded a model object</span>
        <span class="c1">#  load() will load any gnome object from json...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This does not appear to be a save file for a model</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;loaded a </span><span class="si">%s</span><span class="s2"> instead&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">time_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">start_time</span><span class="o">=</span><span class="n">round_time</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="mi">3600</span><span class="p">),</span>
                 <span class="n">duration</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                 <span class="n">weathering_substeps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="nb">map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">uncertain</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">cache_enabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initializes a model.</span>
<span class="sd">        All arguments have a default.</span>

<span class="sd">        :param time_step=timedelta(minutes=15): model time step in seconds</span>
<span class="sd">                                                or as a timedelta object</span>

<span class="sd">        :param start_time=datetime.now(): start time of model, datetime</span>
<span class="sd">                                          object. Rounded to the nearest hour.</span>

<span class="sd">        :param duration=timedelta(days=1): How long to run the model,</span>
<span class="sd">                                           a timedelta object.</span>

<span class="sd">        :param int weathering_substeps=1: How many weathering substeps to</span>
<span class="sd">                                          run inside a single model time step.</span>

<span class="sd">        :param map=gnome.map.GnomeMap(): The land-water map.</span>

<span class="sd">        :param uncertain=False: Flag for setting uncertainty.</span>

<span class="sd">        :param cache_enabled=False: Flag for setting whether the model should</span>
<span class="sd">                                    cache results to disk.</span>

<span class="sd">        :param mode=&#39;Gnome&#39;: The runtime &#39;mode&#39; that the model should use.</span>
<span class="sd">                             This is a value that the Web Client uses to</span>
<span class="sd">                             decide which UI views it should present.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__restore__</span><span class="p">(</span><span class="n">time_step</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                         <span class="n">weathering_substeps</span><span class="p">,</span>
                         <span class="n">uncertain</span><span class="p">,</span> <span class="n">cache_enabled</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_register_callbacks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_register_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Register callbacks with the OrderedCollections</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_add_mover</span><span class="p">,</span>
                                      <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_add_weatherer_env</span><span class="p">,</span>
                                          <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_add_weatherer_env</span><span class="p">,</span>
                                           <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_add_outputter</span><span class="p">,</span>
                                          <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback_add_spill</span><span class="p">,</span>
                                      <span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__restore__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                    <span class="n">weathering_substeps</span><span class="p">,</span> <span class="n">uncertain</span><span class="p">,</span> <span class="n">cache_enabled</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span>
                    <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Take out initialization that does not register the callback here.</span>
<span class="sd">        This is because new_from_dict will use this to restore the model _state</span>
<span class="sd">        when doing a midrun persistence.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># making sure basic stuff is in place before properties are set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">OrderedCollection</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Environment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">movers</span> <span class="o">=</span> <span class="n">OrderedCollection</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Mover</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span> <span class="o">=</span> <span class="n">OrderedCollection</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Weatherer</span><span class="p">)</span>

        <span class="c1"># contains both certain/uncertain spills</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spills</span> <span class="o">=</span> <span class="n">SpillContainerPair</span><span class="p">(</span><span class="n">uncertain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">gnome</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">ElementCache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">cache_enabled</span>

        <span class="c1"># list of output objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span> <span class="o">=</span> <span class="n">OrderedCollection</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">Outputter</span><span class="p">)</span>

        <span class="c1"># default to now, rounded to the nearest hour</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weathering_substeps</span> <span class="o">=</span> <span class="n">weathering_substeps</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">map</span><span class="p">:</span>
            <span class="nb">map</span> <span class="o">=</span> <span class="n">gnome</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">GnomeMap</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Model mode (</span><span class="si">{}</span><span class="s1">) invalid, &#39;</span>
                                 <span class="s1">&#39;should be one of {{</span><span class="si">{}</span><span class="s1">}}&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;gnome&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="nb">map</span>

        <span class="c1"># reset _current_time_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time_step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">time_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="n">time_step</span>  <span class="c1"># this calls rewind() !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_num_time_steps</span><span class="p">()</span>

        <span class="c1"># default is to zip save file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zipsave</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># model creates references to weatherers/environment if</span>
        <span class="c1"># make_default_refs is True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_default_refs</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="Model.reset"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resets model to defaults -- Caution -- clears all movers, spills, etc.</span>
<span class="sd">        Takes same keyword arguments as :meth:`__init__()`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.rewind"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.rewind">[docs]</a>    <span class="k">def</span> <span class="nf">rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Rewinds the model to the beginning (start_time)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time_step</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>

        <span class="c1"># fixme: do the movers need re-setting? -- or wait for</span>
        <span class="c1">#        prepare_for_model_run?</span>

        <span class="c1"># note: This may be redundant.  They will get reset in</span>
        <span class="c1">#       setup_model_run() anyway..</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="c1"># set rand before each call so windages are set correctly</span>
        <span class="n">gnome</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">rand</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># clear the cache:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">outputter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">:</span>
            <span class="n">outputter</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pid</span> <span class="o">+</span> <span class="s2">&quot;rewound model - &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<span class="c1">#    def write_from_cache(self, filetype=&#39;netcdf&#39;, time_step=&#39;all&#39;):</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#        write the already-cached data to an output files.</span>
<span class="c1">#        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uncertain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uncertainty attribute of the model. If flag is toggled, rewind model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">uncertain</span>

    <span class="nd">@uncertain</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uncertain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uncertain_value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uncertainty attribute of the model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">uncertain</span> <span class="o">!=</span> <span class="n">uncertain_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">uncertain</span> <span class="o">=</span> <span class="n">uncertain_value</span>  <span class="c1"># update uncertainty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If True, then generated data is cached</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">enabled</span>

    <span class="nd">@cache_enabled</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cache_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_weathering_uncertainty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">on</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">])</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">([</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">WeatheringOutput</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">amount_uncertainty_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">])</span> <span class="ow">or</span>
                 <span class="nb">any</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">speed_uncertainty_scale</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                     <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">Wind</span><span class="p">)]))</span>
                <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start time of the simulation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span>

    <span class="nd">@start_time</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        time step over which the dynamics is computed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span>

    <span class="nd">@time_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_step</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sets the time step, and rewinds the model</span>

<span class="sd">        :param time_step: The timestep can be a timedelta object</span>
<span class="sd">                          or integer seconds.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="n">time_step</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time_step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_num_time_steps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Current timestep of the simulation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_time_step</span>

    <span class="nd">@current_time_step</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">step</span> <span class="o">*</span> 
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_time_step</span> <span class="o">=</span> <span class="n">step</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        total duration of the model run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span>

    <span class="nd">@duration</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span><span class="p">:</span>
            <span class="c1"># only need to rewind if shorter than it was...</span>
            <span class="c1"># fixme: actually, only need to rewind if current model time</span>
            <span class="c1"># is beyond new time...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duration</span> <span class="o">=</span> <span class="n">duration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_num_time_steps</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        land water map used for simulation</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_map</span>

    <span class="nd">@map</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_in</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="n">map_in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_time_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read only attribute</span>
<span class="sd">        computed number of timesteps based on py:attribute:`duration` and</span>
<span class="sd">        py:attribute:`time_step`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_time_steps</span>

    <span class="k">def</span> <span class="nf">_reset_num_time_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        reset number of time steps if duration, or time_step change</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># We do not count any remainder time.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initial_0th_step</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_time_steps</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_0th_step</span> <span class="o">+</span> 
                                    <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">//</span> 
                                        <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_num_time_steps</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Model.contains_object"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.contains_object">[docs]</a>    <span class="k">def</span> <span class="nf">contains_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">obj_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj_id</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;contains_object&#39;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">o</span><span class="o">.</span><span class="n">contains_object</span><span class="p">(</span><span class="n">obj_id</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Model.find_by_class"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.find_by_class">[docs]</a>    <span class="k">def</span> <span class="nf">find_by_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">ret_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Look for an object that isinstance() of obj in specified colleciton.</span>
<span class="sd">        By default, it will return the first object of this type.</span>
<span class="sd">        To get all obects of this type, set ret_all to True</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">all_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ret_all</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">obj</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">all_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_objs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">all_objs</span></div>

<div class="viewcode-block" id="Model.find_by_attr"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.find_by_attr">[docs]</a>    <span class="k">def</span> <span class="nf">find_by_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">allitems</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        find first object in collection where the &#39;attr&#39; attribute matches</span>
<span class="sd">        &#39;value&#39;. This is primarily used to find &#39;wind&#39;, &#39;water&#39;, &#39;waves&#39;</span>
<span class="sd">        objects in environment collection. Use the &#39;_ref_as&#39; attribute to</span>
<span class="sd">        search.</span>

<span class="sd">        Ignore AttributeError since all objects in collection may not contain</span>
<span class="sd">        the attribute over which we are searching.</span>

<span class="sd">        :param str attr: attribute whose value must match</span>
<span class="sd">        :param str value: desired value of the attribute</span>
<span class="sd">        :param OrderedCollection collection: the ordered collection in which</span>
<span class="sd">            to search</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">basestring</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">value</span> <span class="o">==</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]):</span>
                        <span class="k">if</span> <span class="n">allitems</span><span class="p">:</span>
                            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">item</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">allitems</span><span class="p">:</span>
                            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">item</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">items</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">items</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">items</span>

        <span class="k">return</span> <span class="n">items</span></div>

    <span class="k">def</span> <span class="nf">_order_weatherers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s1">&#39;use weatherer_sort to sort the weatherers&#39;</span>
        <span class="n">s_weatherers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">weatherer_sort</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="o">!=</span> <span class="n">s_weatherers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span> <span class="o">+=</span> <span class="n">s_weatherers</span>

    <span class="k">def</span> <span class="nf">_attach_references</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        attach references</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;wind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_attr</span><span class="p">(</span><span class="s1">&#39;_ref_as&#39;</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
        <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_attr</span><span class="p">(</span><span class="s1">&#39;_ref_as&#39;</span><span class="p">,</span> <span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
        <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;waves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_attr</span><span class="p">(</span><span class="s1">&#39;_ref_as&#39;</span><span class="p">,</span> <span class="s1">&#39;waves&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>

        <span class="n">weather_data</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">wd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">spread</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="s1">&#39;movers&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coll</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;_req_refs&#39;</span><span class="p">):</span>
                    <span class="n">ref_dict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">_req_refs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_attr</span><span class="p">(</span><span class="s1">&#39;_ref_as&#39;</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ref_dict</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref_dict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">_attach_default_refs</span><span class="p">(</span><span class="n">ref_dict</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">coll</span> <span class="o">==</span> <span class="s1">&#39;weatherers&#39;</span><span class="p">:</span>
                        <span class="c1"># by default turn WeatheringData and spreading object off</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">WeatheringData</span><span class="p">):</span>
                            <span class="n">item</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">wd</span> <span class="o">=</span> <span class="n">item</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">_ref_as</span> <span class="o">==</span> <span class="s1">&#39;spreading&#39;</span><span class="p">:</span>
                                <span class="n">item</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">spread</span> <span class="o">=</span> <span class="n">item</span>

                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                            <span class="n">weather_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                        <span class="c1"># no need to setup references if item is not on</span>
                        <span class="k">continue</span>

                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                                <span class="n">item</span><span class="o">.</span><span class="n">make_default_refs</span><span class="p">):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="n">all_spills</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp</span>
                      <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                      <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">spill</span> <span class="ow">in</span> <span class="n">all_spills</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">spill</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">spill</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                        <span class="n">spill</span><span class="o">.</span><span class="n">make_default_refs</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">spill</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># if WeatheringData object and FayGravityViscous (spreading object)</span>
        <span class="c1"># are not defined by user, add them automatically because most</span>
        <span class="c1"># weatherers will need these</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weather_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span> <span class="o">+=</span> <span class="n">WeatheringData</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># turn mass_balance on and make references</span>
                <span class="n">wd</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">wd</span><span class="o">.</span><span class="n">make_default_refs</span><span class="p">:</span>
                    <span class="n">wd</span><span class="o">.</span><span class="n">water</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">]</span>

        <span class="c1"># if a weatherer is using &#39;area&#39; array, make sure it is being set.</span>
        <span class="c1"># Objects that set &#39;area&#39; are referenced as &#39;spreading&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;area&#39;</span> <span class="ow">in</span> <span class="n">weather_data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span> <span class="o">+=</span> <span class="n">FayGravityViscous</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># turn spreading on and make references</span>
                <span class="n">spread</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">spread</span><span class="o">.</span><span class="n">make_default_refs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spread</span><span class="p">,</span> <span class="n">at</span><span class="p">):</span>
                            <span class="n">spread</span><span class="o">.</span><span class="n">water</span> <span class="o">=</span> <span class="n">attr</span><span class="p">[</span><span class="s1">&#39;water&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Model.setup_model_run"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.setup_model_run">[docs]</a>    <span class="k">def</span> <span class="nf">setup_model_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sets up each mover for the model run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># use a set since we only want to add unique &#39;names&#39; for data_arrays</span>
        <span class="c1"># that will be added</span>
        <span class="n">array_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># attach references so objects don&#39;t raise ReferencedObjectNotSet error</span>
        <span class="c1"># in prepare_for_model_run()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attach_references</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>  <span class="c1"># why is rewind for spills here?</span>

        <span class="c1"># remake orderedcollections defined by model</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">]:</span>
            <span class="n">oc</span><span class="o">.</span><span class="n">remake</span><span class="p">()</span>

        <span class="c1"># order weatherers collection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_order_weatherers</span><span class="p">()</span>
        <span class="n">transport</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">mover</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mover</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                <span class="n">mover</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">()</span>
                <span class="n">transport</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">array_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mover</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>

        <span class="n">weathering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># weatherers will initialize &#39;mass_balance&#39; key/values</span>
                <span class="c1"># to 0.0</span>
                <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                    <span class="n">weathering</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">array_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">environment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># for now hard-code this; however, it should depend on weathering</span>
            <span class="c1"># note: do not set time_step attribute because we don&#39;t want to</span>
            <span class="c1"># rewind because that will reset spill_container data</span>
            <span class="k">if</span> <span class="n">transport</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="mi">900</span>
            <span class="k">elif</span> <span class="n">weathering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">transport</span><span class="p">:</span>
                <span class="c1"># todo: 1 hour</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="mi">3600</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># simple case with no weatherers or movers</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span> <span class="o">=</span> <span class="mi">900</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_num_time_steps</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="n">array_types</span><span class="p">)</span>

        <span class="c1"># outputters need array_types, so this needs to come after those</span>
        <span class="c1"># have been updated.</span>
        <span class="k">for</span> <span class="n">outputter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">:</span>
            <span class="n">outputter</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="n">model_start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                                            <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span>
                                            <span class="n">uncertain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">,</span>
                                            <span class="n">spills</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">,</span>
                                            <span class="n">model_time_step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0._pid}</span><span class="s2"> setup_model_run complete for: &quot;</span>
                          <span class="s2">&quot;</span><span class="si">{0.name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="Model.setup_time_step"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.setup_time_step">[docs]</a>    <span class="k">def</span> <span class="nf">setup_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        sets up everything for the current time_step:</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># initialize movers differently if model uncertainty is on</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">m</span><span class="o">.</span><span class="n">prepare_for_model_step</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># maybe we will setup a super-sampling step here???</span>
                <span class="n">w</span><span class="o">.</span><span class="n">prepare_for_model_step</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">environment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
            <span class="n">environment</span><span class="o">.</span><span class="n">prepare_for_model_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">outputter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">:</span>
            <span class="n">outputter</span><span class="o">.</span><span class="n">prepare_for_model_step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.move_elements"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.move_elements">[docs]</a>    <span class="k">def</span> <span class="nf">move_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Moves elements:</span>
<span class="sd">         - loops through all the movers. and moves the elements</span>
<span class="sd">         - sets new_position array for each spill</span>
<span class="sd">         - calls the beaching code to beach the elements that need beaching.</span>
<span class="sd">         - sets the new position</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">num_released</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># can this check be removed?</span>

                <span class="c1"># possibly refloat elements</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">refloat_elements</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">)</span>

                <span class="c1"># reset next_positions</span>
                <span class="p">(</span><span class="n">sc</span><span class="p">[</span><span class="s1">&#39;next_positions&#39;</span><span class="p">])[:]</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span>

                <span class="c1"># loop through the movers</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">:</span>
                    <span class="n">delta</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_move</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span>
                    <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;next_positions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">beach_elements</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

                <span class="c1"># let model mark these particles to be removed</span>
                <span class="n">tbr_mask</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;status_codes&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">oil_status</span><span class="o">.</span><span class="n">off_maps</span>
                <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;status_codes&#39;</span><span class="p">][</span><span class="n">tbr_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">oil_status</span><span class="o">.</span><span class="n">to_be_removed</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_update_fate_status</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

                <span class="c1"># the final move to the new positions</span>
                <span class="p">(</span><span class="n">sc</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">])[:]</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;next_positions&#39;</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_update_fate_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        WeatheringData used to perform this operation in weather_elements;</span>
<span class="sd">        however, WeatheringData is one of the objects in weatherers collection</span>
<span class="sd">        so just let model do this for now. Eventually, we want to get rid</span>
<span class="sd">        of &#39;fate_status&#39; array and only manipulate &#39;status_codes&#39;. Until then,</span>
<span class="sd">        update fate_status in move_elements</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;fate_status&#39;</span> <span class="ow">in</span> <span class="n">sc</span><span class="p">:</span>
            <span class="n">non_w_mask</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;status_codes&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">oil_status</span><span class="o">.</span><span class="n">on_land</span>
            <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;fate_status&#39;</span><span class="p">][</span><span class="n">non_w_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">fate</span><span class="o">.</span><span class="n">non_weather</span>

<div class="viewcode-block" id="Model.weather_elements"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.weather_elements">[docs]</a>    <span class="k">def</span> <span class="nf">weather_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Weathers elements:</span>

<span class="sd">        - loops through all the weatherers, passing in the spill_container</span>
<span class="sd">          and the time range</span>
<span class="sd">        - a weatherer modifies the data arrays in the spill container, so a</span>
<span class="sd">          particular time range should not be run multiple times.  It is</span>
<span class="sd">          expected that we are processing a sequence of contiguous time ranges.</span>
<span class="sd">        - Note: If there are multiple sequential weathering processes, some</span>
<span class="sd">          inaccuracy could occur.  A proposed solution is to</span>
<span class="sd">          &#39;super-sample&#39; the model time step so that it will be replaced</span>
<span class="sd">          with many smaller time steps.  We&#39;ll have to see if this pans</span>
<span class="sd">          out in practice.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># if no weatherers then mass_components array may not be defined</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># elements may have beached to update fate_status</span>

            <span class="n">sc</span><span class="o">.</span><span class="n">reset_fate_dataview</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">model_time</span><span class="p">,</span> <span class="n">time_step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_into_substeps</span><span class="p">():</span>
                    <span class="c1"># change &#39;mass_components&#39; in weatherer</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">weather_elements</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">time_step</span><span class="p">,</span> <span class="n">model_time</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_split_into_substeps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :return: sequence of (datetime, timestep)</span>
<span class="sd">         (Note: we divide evenly on second boundaries.</span>
<span class="sd">                   Thus, there will likely be a remainder</span>
<span class="sd">                   that needs to be included.  We include</span>
<span class="sd">                   this remainder, which results in</span>
<span class="sd">                   1 more sub-step than we requested.)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">time_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_step</span><span class="p">)</span>
        <span class="n">sub_step</span> <span class="o">=</span> <span class="n">time_step</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">weathering_substeps</span>

        <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">time_step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sub_step</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[(</span><span class="n">idx</span><span class="p">,</span> <span class="n">next_idx</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">next_idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indexes</span><span class="p">,</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">time_step</span><span class="p">:</span>
            <span class="c1"># collect the remaining slice</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">time_step</span> <span class="o">%</span> <span class="n">sub_step</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_time</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">idx</span><span class="p">),</span> <span class="n">delta</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">delta</span> <span class="ow">in</span> <span class="n">res</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="Model.step_is_done"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.step_is_done">[docs]</a>    <span class="k">def</span> <span class="nf">step_is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loop through movers and weatherers and call model_step_is_done</span>

<span class="sd">        Remove elements that marked for removal</span>

<span class="sd">        Output data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">mover</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">mover</span><span class="o">.</span><span class="n">model_step_is_done</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">w</span><span class="o">.</span><span class="n">model_step_is_done</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">outputter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">:</span>
            <span class="n">outputter</span><span class="o">.</span><span class="n">model_step_is_done</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            removes elements with oil_status.to_be_removed</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">model_step_is_done</span><span class="p">()</span>

            <span class="c1"># age remaining particles</span>
            <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">][:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span></div>

<div class="viewcode-block" id="Model.write_output"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.write_output">[docs]</a>    <span class="k">def</span> <span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valid</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">output_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;step_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">outputter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputters</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_time_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">outputter</span><span class="o">.</span><span class="n">write_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">outputter</span><span class="o">.</span><span class="n">write_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output_info</span><span class="p">[</span><span class="n">outputter</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># append &#39;valid&#39; flag to output</span>
            <span class="n">output_info</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid</span>

        <span class="k">return</span> <span class="n">output_info</span></div>

<div class="viewcode-block" id="Model.step"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.step">[docs]</a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Steps the model forward (or backward) in time. Needs testing for</span>
<span class="sd">        hind casting.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Set the current time stamp only after current_time_step is</span>
            <span class="c1"># incremented and before the output is written. Set it to None here</span>
            <span class="c1"># just so we&#39;re not carrying around the old time_stamp</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">current_time_stamp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># that&#39;s all we need to do for the zeroth time step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_model_run</span><span class="p">()</span>

            <span class="c1"># let each object raise appropriate error if obj is incomplete</span>
            <span class="c1"># validate and send validation flag if model is invalid</span>
            <span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_inputs</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isvalid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Setup model run complete but model &quot;</span>
                                   <span class="s2">&quot;is invalid&quot;</span><span class="p">,</span> <span class="n">msgs</span><span class="p">)</span>
            <span class="c1"># (msgs, isvalid) = self.validate()</span>
            <span class="c1"># if not isvalid:</span>
            <span class="c1">#    raise StopIteration(&quot;Setup model run complete but model &quot;</span>
            <span class="c1">#                        &quot;is invalid&quot;, msgs)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_num_time_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># _num_time_steps is set when self.time_step is set. If user does</span>
            <span class="c1"># not specify time_step, then setup_model_run() automatically</span>
            <span class="c1"># initializes it. Thus, do StopIteration check after</span>
            <span class="c1"># setup_model_run() is invoked</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s2">&quot;Run complete for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_time_step</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_elements</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weather_elements</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_is_done</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># this is where the new step begins!</span>
        <span class="c1"># the elements released are during the time period:</span>
        <span class="c1">#    self.model_time + self.time_step</span>
        <span class="c1"># The else part of the loop computes values for data_arrays that</span>
        <span class="c1"># correspond with time_stamp:</span>
        <span class="c1">#    self.model_time + self.time_step</span>
        <span class="c1"># This is the current_time_stamp attribute of the SpillContainer</span>
        <span class="c1">#     [sc.current_time_stamp for sc in self.spills.items()]</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">current_time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span>

            <span class="c1"># release particles for next step - these particles will be aged</span>
            <span class="c1"># in the next step</span>
            <span class="n">num_released</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">release_elements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_time</span><span class="p">)</span>

            <span class="c1"># initialize data - currently only weatherers do this so cycle</span>
            <span class="c1"># over weatherers collection - in future, maybe movers can also do</span>
            <span class="c1"># this</span>
            <span class="k">if</span> <span class="n">num_released</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">initialize_data</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">num_released</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{1._pid}</span><span class="s2"> released </span><span class="si">{0}</span><span class="s2"> new elements for step:&quot;</span>
                              <span class="s2">&quot; </span><span class="si">{1.current_time_step}</span><span class="s2"> for </span><span class="si">{1.name}</span><span class="s2">&quot;</span><span class="o">.</span>
                              <span class="nb">format</span><span class="p">(</span><span class="n">num_released</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="c1"># cache the results - current_time_step is incremented but the</span>
        <span class="c1"># current_time_stamp in spill_containers (self.spills) is not updated</span>
        <span class="c1"># till we go through the prepare_for_model_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">save_timestep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">)</span>
        <span class="n">output_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_output</span><span class="p">(</span><span class="n">isvalid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0._pid}</span><span class="s2"> Completed step: </span><span class="si">{0.current_time_step}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;for </span><span class="si">{0.name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">output_info</span></div>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Rewinds the model and returns itself so it can be iterated over.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Model.next"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        (This method satisfies Python&#39;s iterator and generator protocols)</span>

<span class="sd">        :return: the step number</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.full_run"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.full_run">[docs]</a>    <span class="k">def</span> <span class="nf">full_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rewind</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Do a full run of the model.</span>

<span class="sd">        :param rewind=True: whether to rewind the model first -- if set to</span>
<span class="sd">            false, model will be run from the current step to the end</span>
<span class="sd">        :returns: list of outputter info dicts</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">rewind</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="c1"># run the model</span>
        <span class="n">output_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

                <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Run Complete: Stop Iteration&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">output_data</span></div>

    <span class="k">def</span> <span class="nf">_add_to_environ_collec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_added</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        if an environment object exists in obj_added, but not in the Model&#39;s</span>
<span class="sd">        environment collection, then add it automatically.</span>
<span class="sd">        todo: maybe we don&#39;t want to do this - revisit this requirement</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_added</span><span class="p">,</span> <span class="s1">&#39;wind&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">wind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">wind</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">+=</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">wind</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_added</span><span class="p">,</span> <span class="s1">&#39;tide&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">tide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">tide</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">+=</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">tide</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_added</span><span class="p">,</span> <span class="s1">&#39;waves&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">waves</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">waves</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">+=</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">waves</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj_added</span><span class="p">,</span> <span class="s1">&#39;water&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">water</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">water</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">+=</span> <span class="n">obj_added</span><span class="o">.</span><span class="n">water</span>

    <span class="k">def</span> <span class="nf">_callback_add_mover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_added</span><span class="p">):</span>
        <span class="s1">&#39;Callback after mover has been added&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_environ_collec</span><span class="p">(</span><span class="n">obj_added</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>  <span class="c1"># rewind model if a new mover is added</span>

    <span class="k">def</span> <span class="nf">_callback_add_outputter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_added</span><span class="p">):</span>
        <span class="s1">&#39;Callback after outputter has been added&#39;</span>
        <span class="c1"># hook up the cache</span>
        <span class="n">obj_added</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="k">def</span> <span class="nf">_callback_add_weatherer_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_added</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Callback after weatherer/environment object has been added. &#39;waves&#39;</span>
<span class="sd">        environment object contains &#39;wind&#39; and &#39;water&#39; so add those to</span>
<span class="sd">        environment collection and the &#39;water&#39; attribute.</span>
<span class="sd">        todo: simplify this</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_to_environ_collec</span><span class="p">(</span><span class="n">obj_added</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>  <span class="c1"># rewind model if a new weatherer is added</span>

    <span class="k">def</span> <span class="nf">_callback_add_spill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_added</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">check</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check</span><span class="p">:</span>
            <span class="c1"># also check the data in ordered collections</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">__class__</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">spills</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">check</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Following methods are for saving a Model instance or creating a new</span>
<span class="sd">    model instance from a saved location</span>
<span class="sd">    &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Model.spills_to_dict"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.spills_to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">spills_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return the spills ordered collection for serialization</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s1">&#39;spills&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.spills_update_from_dict"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.spills_update_from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">spills_update_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s1">&#39;invoke SpillContainerPair().update_from_dict&#39;</span>
        <span class="c1"># containers don&#39;t need to be serializable; however, it was easiest to</span>
        <span class="c1"># put an update_from_dict method in the SpillContainerPair. Keep the</span>
        <span class="c1"># interface for this the same, so make it a dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">update_from_dict</span><span class="p">({</span><span class="s1">&#39;spills&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span></div>

<div class="viewcode-block" id="Model.uncertain_spills_to_dict"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.uncertain_spills_to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">uncertain_spills_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        return the uncertain_spills ordered collection for serialization/save</span>
<span class="sd">        files</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
            <span class="n">dict_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;uncertain_spills&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_create_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        create a zipfile and update saveloc to point to it. This is now</span>
<span class="sd">        passed down to all the objects contained within the Model so they can</span>
<span class="sd">        save themselves to zipfile</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zipsave</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">z_name</span> <span class="o">=</span> <span class="s1">&#39;Model.zip&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_name</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span>

            <span class="c1"># create the zipfile and update saveloc - _json_to_saveloc checks</span>
            <span class="c1"># to see if saveloc is a zipfile</span>
            <span class="n">saveloc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">z_name</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                                <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span>
                                <span class="n">allowZip64</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowzip64</span><span class="p">)</span>
            <span class="n">z</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">saveloc</span>

<div class="viewcode-block" id="Model.save"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        save the model state in saveloc. If self.zipsave is True, then a</span>
<span class="sd">        zip archive is created and model files are saved to the archive.</span>

<span class="sd">        This overrides the base class save(). Model contains collections and</span>
<span class="sd">        model must invoke save for each object in the collection. It must also</span>
<span class="sd">        save the data in the SpillContainer&#39;s if it is a mid-run save.</span>

<span class="sd">        :param saveloc: zip archive or a valid directory. Model files are</span>
<span class="sd">            either persisted here or a new model is re-created from the files</span>
<span class="sd">            stored here. The files are clobbered when save() is called.</span>
<span class="sd">        :type saveloc: A path as a string or unicode</span>

<span class="sd">        :param name=None: If data is saved to zipfile (default behavior), then</span>
<span class="sd">            this is name of zip file. For a zipfile, the model&#39;s state is</span>
<span class="sd">            always contained in Model.json. If zipsave is False, then model&#39;s</span>
<span class="sd">            json is stored in name.json</span>
<span class="sd">        :type name: str</span>

<span class="sd">        :param references: dict of references mapping &#39;id&#39; to a string used for</span>
<span class="sd">            the reference. The value could be a unique integer or it could be</span>
<span class="sd">            a filename. It is upto the creator of the reference list to decide</span>
<span class="sd">            how to reference a nested object.</span>

<span class="sd">        :returns: references</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># if zipsave is on, the create zip and update saveloc</span>
        <span class="n">saveloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_zip</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Note: Defining references=References() in the function definition</span>
        <span class="c1"># keeps the references object in memory between tests - it changes the</span>
        <span class="c1"># scope of References() to be outside the Model() instance. We don&#39;t</span>
        <span class="c1"># want this so define the default here</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">(</span><span class="n">references</span><span class="p">,</span> <span class="n">References</span><span class="p">())[</span><span class="n">references</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">json_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">)</span>

        <span class="c1"># map is the only nested structure - let&#39;s manually call</span>
        <span class="c1"># _move_data_file on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">_move_data_file</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">json_</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oc_list</span><span class="p">:</span>
            <span class="n">coll_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_collection</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">coll_</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="n">json_</span><span class="p">[</span><span class="n">oc</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;uncertain_spills&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;spills&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_save_collection</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">spills</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="n">json_</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            hard code the filename - can make this an attribute if user wants</span>
<span class="sd">            to change it - but not sure if that will ever be needed?</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_spill_data</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="s1">&#39;spills_data_arrays.nc&#39;</span><span class="p">)</span>

        <span class="c1"># if saved as zipfile, then store model&#39;s json in Model.json - this is</span>
        <span class="c1"># default if name is None</span>
        <span class="n">mdl_name</span> <span class="o">=</span> <span class="s1">&#39;Model.json&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zipsave</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_to_saveloc</span><span class="p">(</span><span class="n">json_</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="n">mdl_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">references</span></div>

    <span class="k">def</span> <span class="nf">_save_spill_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        save the data arrays for current timestep to NetCDF</span>
<span class="sd">        If saveloc is zipfile, then move NetCDF to zipfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zipname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">saveloc</span><span class="p">):</span>
            <span class="n">saveloc</span><span class="p">,</span> <span class="n">zipname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">saveloc</span><span class="p">)</span>

        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">)</span>
        <span class="n">nc_out</span> <span class="o">=</span> <span class="n">NetCDFOutput</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">which_data</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">nc_out</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="n">model_start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                                     <span class="n">uncertain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">,</span>
                                     <span class="n">spills</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">)</span>
        <span class="n">nc_out</span><span class="o">.</span><span class="n">write_output</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_time_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">zipname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">zipname</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
                                 <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">,</span>
                                 <span class="n">allowZip64</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_allowzip64</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
                    <span class="n">u_file</span> <span class="o">=</span> <span class="n">nc_out</span><span class="o">.</span><span class="n">uncertain_filename</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">u_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_spill_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        load NetCDF file and add spill data back in - designed for savefiles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">saveloc</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">nc_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">z</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                    <span class="k">return</span>

                <span class="n">saveloc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">saveloc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">z</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">nc_file</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
                    <span class="n">spill_data_fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_uncertain</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spill_data_fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">)</span>

        <span class="n">spill_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="n">nc_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">spill_data</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
            <span class="n">spill_data_fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">nc_file</span><span class="p">)</span>
            <span class="n">u_spill_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span>
                                        <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_uncertain</span><span class="si">{1}</span><span class="s1">&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spill_data_fname</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>

        <span class="n">array_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">movers</span><span class="p">:</span>
            <span class="n">array_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weatherers</span><span class="p">:</span>
            <span class="n">array_types</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">array_types</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">prepare_for_model_run</span><span class="p">(</span><span class="n">array_types</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
                <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weather_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">NetCDFOutput</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">u_spill_data</span><span class="p">,</span>
                                                              <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                              <span class="n">which_data</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weather_data</span><span class="p">)</span> <span class="o">=</span> <span class="n">NetCDFOutput</span><span class="o">.</span><span class="n">read_data</span><span class="p">(</span><span class="n">spill_data</span><span class="p">,</span>
                                                              <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                              <span class="n">which_data</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

            <span class="n">sc</span><span class="o">.</span><span class="n">current_time_stamp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;current_time_stamp&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">_data_arrays</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">mass_balance</span> <span class="o">=</span> <span class="n">weather_data</span>

        <span class="c1"># delete file after data is loaded - since no longer needed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">spill_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertain</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u_spill_data</span><span class="p">)</span>

    <span class="c1"># todo: remove following</span>

    <span class="k">def</span> <span class="nf">_empty_save_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove all files, directories under saveloc</span>

<span class="sd">        First clean out directory, then add new save files</span>
<span class="sd">        This should only be called by self.save()</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">saveloc</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dir_</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dir_</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">file_</span><span class="p">))</span>

<div class="viewcode-block" id="Model.serialize"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_</span><span class="o">=</span><span class="s1">&#39;webapi&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Serialize Model object</span>
<span class="sd">        treat special-case attributes of Model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">toserial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_serialize</span><span class="p">(</span><span class="n">json_</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">_schema</span><span class="p">(</span><span class="n">json_</span><span class="p">)</span>

        <span class="n">o_json_</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">toserial</span><span class="p">)</span>
        <span class="n">o_json_</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">json_</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">json_</span> <span class="o">==</span> <span class="s1">&#39;webapi&#39;</span><span class="p">:</span>
            <span class="c1"># for webapi, we serialize forecast spills just like all other</span>
            <span class="c1"># collections - ignore spills in uncertain spill container</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;outputters&#39;</span><span class="p">,</span> <span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="s1">&#39;movers&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;spills&#39;</span><span class="p">):</span>
                <span class="n">o_json_</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_oc</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">json_</span><span class="p">)</span>

            <span class="n">o_json_</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">o_json_</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># validate and send validation flag</span>
<span class="c1">#             (msgs, isvalid) = self.validate()</span>
<span class="c1">#             o_json_[&#39;valid&#39;] = isvalid</span>
<span class="c1">#             if len(msgs) &gt; 0:</span>
<span class="c1">#                 o_json_[&#39;messages&#39;] = msgs</span>
<span class="c1">#             else:</span>
<span class="c1">#                 o_json_[&#39;messages&#39;] = []</span>

        <span class="k">return</span> <span class="n">o_json_</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Model.deserialize"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.deserialize">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        treat special-case attributes of Model.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_schema</span><span class="p">(</span><span class="n">json_</span><span class="p">[</span><span class="s1">&#39;json_&#39;</span><span class="p">])</span>
        <span class="n">deserial</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">json_</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;map&#39;</span> <span class="ow">in</span> <span class="n">json_</span><span class="p">:</span>
            <span class="c1"># d_item = cls._deserialize_nested_obj(json_[&#39;map&#39;])</span>
            <span class="c1"># deserial[&#39;map&#39;] = d_item</span>
            <span class="c1"># map will be deserialized later - no need to do it twice</span>
            <span class="c1"># todo: clean this up</span>
            <span class="n">deserial</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">json_</span><span class="p">[</span><span class="s1">&#39;json_&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;webapi&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span> <span class="s1">&#39;outputters&#39;</span><span class="p">,</span> <span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="s1">&#39;movers&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;spills&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">json_</span><span class="p">:</span>
                    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">                    even if list is empty, deserialize it because we still need</span>
<span class="sd">                    to sync up with client</span>
<span class="sd">                    &#39;&#39;&#39;</span>
                    <span class="n">deserial</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">deserialize_oc</span><span class="p">(</span><span class="n">json_</span><span class="p">[</span><span class="n">attr</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">deserial</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Model.loads"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.loads">[docs]</a>    <span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        loads a model from json_data</span>

<span class="sd">        - load json for references from files</span>
<span class="sd">        - update paths of datafiles if needed</span>
<span class="sd">        - deserialize json_data</span>
<span class="sd">        - and create object with new_from_dict()</span>

<span class="sd">        :param saveloc: location of data files</span>

<span class="sd">        Optional parameter</span>

<span class="sd">        :param references: references object - if this is called by the Model,</span>
<span class="sd">            it will pass a references object. It is not required.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">references</span> <span class="o">=</span> <span class="p">(</span><span class="n">references</span><span class="p">,</span> <span class="n">References</span><span class="p">())[</span><span class="n">references</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">ref_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_load_refs</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">references</span><span class="p">)</span>

        <span class="c1"># there are no datafiles for model properties; so no need for following</span>
        <span class="c1"># at present</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_update_datafile_path</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">saveloc</span><span class="p">)</span>

        <span class="c1"># deserialize after removing references</span>
        <span class="n">_to_dict</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref_dict</span><span class="p">:</span>
            <span class="n">_to_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ref_dict</span><span class="p">)</span>

        <span class="c1"># load nested map object and add it - currently, &#39;load&#39; is only used</span>
        <span class="c1"># for laoding save files/location files, so it assumes:</span>
        <span class="c1"># json_data[&#39;json_&#39;] == &#39;save&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;map&#39;</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">):</span>
            <span class="n">mapcls</span> <span class="o">=</span> <span class="n">class_from_objtype</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;obj_type&#39;</span><span class="p">))</span>
            <span class="n">map_obj</span> <span class="o">=</span> <span class="n">mapcls</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">],</span> <span class="n">saveloc</span><span class="p">,</span> <span class="n">references</span><span class="p">)</span>
            <span class="n">_to_dict</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_obj</span>

        <span class="c1"># load collections</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_oc_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oc</span> <span class="ow">in</span> <span class="n">_to_dict</span><span class="p">:</span>
                <span class="n">_to_dict</span><span class="p">[</span><span class="n">oc</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_load_collection</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span>
                                                    <span class="n">_to_dict</span><span class="p">[</span><span class="n">oc</span><span class="p">],</span>
                                                    <span class="n">references</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spill</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;spills&#39;</span><span class="p">,</span> <span class="s1">&#39;uncertain_spills&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">spill</span> <span class="ow">in</span> <span class="n">_to_dict</span><span class="p">:</span>
                <span class="n">_to_dict</span><span class="p">[</span><span class="n">spill</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_load_collection</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span>
                                                       <span class="n">_to_dict</span><span class="p">[</span><span class="n">spill</span><span class="p">],</span>
                                                       <span class="n">references</span><span class="p">)</span>
            <span class="c1"># also need to load spill data for mid-run save!</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">new_from_dict</span><span class="p">(</span><span class="n">_to_dict</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">_load_spill_data</span><span class="p">(</span><span class="n">saveloc</span><span class="p">,</span> <span class="s1">&#39;spills_data_arrays.nc&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Model.merge"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.merge">[docs]</a>    <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        merge &#39;model&#39; into self</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

        <span class="c1"># update orderedcollections</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oc_list</span><span class="p">:</span>
            <span class="n">my_oc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">)</span>
            <span class="n">new_oc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">oc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">new_oc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">my_oc</span><span class="p">:</span>
                    <span class="n">my_oc</span> <span class="o">+=</span> <span class="n">item</span>

        <span class="c1"># update forecast spills in SpillContainerPair</span>
        <span class="c1"># Uncertain spills automatically be created if uncertainty is on</span>
        <span class="k">for</span> <span class="n">spill</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">spills</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spill</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">spills</span> <span class="o">+=</span> <span class="n">spill</span>

        <span class="c1"># force rewind after merge?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.check_inputs"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.check_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        check the user inputs before running the model</span>
<span class="sd">        raise an exception if user can&#39;t run the model</span>
<span class="sd">        todo: check if all spills start after model ends</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">someSpillIntersectsModel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">num_spills</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spill</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">spill</span><span class="o">.</span><span class="n">release_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">:</span>
                <span class="n">someSpillIntersectsModel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">spill</span><span class="o">.</span><span class="n">release_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has release time after model start time&#39;</span><span class="o">.</span>
                       <span class="nb">format</span><span class="p">(</span><span class="n">spill</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warn_pre</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">spill</span><span class="o">.</span><span class="n">release_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has release time before model start time&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spill</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">spill</span><span class="o">.</span><span class="n">substance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">min_k</span> <span class="o">=</span> <span class="n">spill</span><span class="o">.</span><span class="n">substance</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pour_point_min_k&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spill</span><span class="o">.</span><span class="n">water</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">water_temp</span> <span class="o">=</span> <span class="n">spill</span><span class="o">.</span><span class="n">water</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temperature&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">water_temp</span> <span class="o">&lt;</span> <span class="n">min_k</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The water temperature, </span><span class="si">{0}</span><span class="s1"> K, is less than the minimum pour &#39;</span> 
                               <span class="s1">&#39;point of the selected oil, </span><span class="si">{1}</span><span class="s1"> K. &#39;</span>
                               <span class="s1">&#39;The results may be unreliable.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">water_temp</span><span class="p">,</span> <span class="n">min_k</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warn_pre</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_spills</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">someSpillIntersectsModel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">num_spills</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;All of the spills are released after the &#39;</span>
                       <span class="s1">&#39;time interval being modeled.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The spill is released after the time interval &#39;</span>
                       <span class="s1">&#39;being modeled.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>  <span class="c1"># for now make this a warning</span>
            <span class="c1"># self.logger.error(msg)</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;warning: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="c1"># isvalid = False</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.validate"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        invoke validate for all gnome objects contained in model</span>
<span class="sd">        todo: should also check wind, water, waves are defined if weatherers</span>
<span class="sd">        are defined</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># since model does not contain wind, waves, water attributes, no need</span>
        <span class="c1"># to call base class method - model requires following only if an</span>
        <span class="c1"># object in collection requires it</span>
        <span class="n">env_req</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">oc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oc_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oc</span><span class="p">):</span>
                <span class="c1"># if item is not on, no need to validate it</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">on</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># validate item</span>
                <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">i_isvalid</span><span class="p">)</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">i_isvalid</span><span class="p">:</span>
                    <span class="n">isvalid</span> <span class="o">=</span> <span class="n">i_isvalid</span>

                <span class="n">msgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># add to set of required env objects if item&#39;s</span>
                <span class="c1"># make_default_refs is True</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">make_default_refs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;wind&#39;</span><span class="p">,</span> <span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="s1">&#39;waves&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
                            <span class="n">env_req</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">attr</span><span class="p">})</span>

        <span class="c1"># ensure that required objects are present in environment collection</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_req</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ref_msgs</span><span class="p">,</span> <span class="n">ref_isvalid</span><span class="p">)</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_env_coll</span><span class="p">(</span><span class="n">env_req</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ref_isvalid</span><span class="p">:</span>
                <span class="n">isvalid</span> <span class="o">=</span> <span class="n">ref_isvalid</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ref_msgs</span><span class="p">)</span>

        <span class="c1"># Spill warnings</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> contains no spills&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warn_pre</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spill</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">spill</span><span class="o">.</span><span class="n">release_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has release time after model start time&#39;</span><span class="o">.</span>
                       <span class="nb">format</span><span class="p">(</span><span class="n">spill</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warn_pre</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">spill</span><span class="o">.</span><span class="n">release_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has release time before model start time&#39;</span>
                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spill</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;error: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#             if msg is not None:</span>
<span class="c1">#                 self.logger.warning(msg)</span>
<span class="c1">#                 msgs.append(self._warn_pre + msg)</span>
<span class="c1">#</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_validate_env_coll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refs</span><span class="p">,</span> <span class="n">raise_exc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        validate refs + log warnings or raise error if required refs not found.</span>
<span class="sd">        If refs is None, model must query its weatherers/movers/environment</span>
<span class="sd">        collections to figure out what objects it needs to have in environment.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">refs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># need to go through orderedcollections to see if water, waves</span>
            <span class="c1"># and wind refs are required</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;validate_refs() incomplete&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_by_attr</span><span class="p">(</span><span class="s1">&#39;_ref_as&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> not found in environment collection&quot;</span><span class="o">.</span>
                       <span class="nb">format</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">raise_exc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ReferencedObjectNotSet</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warn_pre</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
                    <span class="n">isvalid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">msgs</span><span class="p">,</span> <span class="n">isvalid</span><span class="p">)</span>

<div class="viewcode-block" id="Model.set_make_default_refs"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.set_make_default_refs">[docs]</a>    <span class="k">def</span> <span class="nf">set_make_default_refs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        make default refs for all items in (&#39;weatherers&#39;, &#39;movers&#39;,</span>
<span class="sd">        &#39;environment&#39;) collections</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;weatherers&#39;</span><span class="p">,</span> <span class="s1">&#39;movers&#39;</span><span class="p">,</span> <span class="s1">&#39;environment&#39;</span><span class="p">):</span>
            <span class="n">oc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">oc</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">make_default_refs</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="Model.get_spill_property"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.get_spill_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_spill_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">ucert</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience method to allow user to look up properties of a spill.</span>
<span class="sd">        User can specify ucert as &#39;ucert&#39; or 1</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ucert</span> <span class="o">==</span> <span class="s1">&#39;ucert&#39;</span><span class="p">:</span>
            <span class="n">ucert</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">ucert</span><span class="p">][</span><span class="n">prop_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Model.get_spill_data"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.get_spill_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_spill_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_properties</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">ucert</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method to allow user to write an expression to filter</span>
<span class="sd">        raw spill data</span>

<span class="sd">        Example case::</span>

<span class="sd">          get_spill_data(&#39;position &amp;&amp; mass&#39;,</span>
<span class="sd">                         &#39;position &gt; 50 &amp;&amp; spill_num == 1 || status_codes == 1&#39;</span>
<span class="sd">                         )</span>

<span class="sd">        WARNING: EXPENSIVE! USE AT YOUR OWN RISK ON LARGE num_elements!</span>

<span class="sd">        Example spill element properties are below. This list may not contain</span>
<span class="sd">        all properties tracked by the model.</span>

<span class="sd">        &#39;positions&#39;, &#39;next_positions&#39;, &#39;last_water_positions&#39;, &#39;status_codes&#39;,</span>
<span class="sd">        &#39;spill_num&#39;, &#39;id&#39;, &#39;mass&#39;, &#39;age&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ucert</span> <span class="o">==</span> <span class="s1">&#39;ucert&#39;</span><span class="p">:</span>
            <span class="n">ucert</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">elem_val</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Gets the column containing the information on one element</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">ucert</span><span class="p">]</span><span class="o">.</span><span class="n">data_arrays</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">val</span>

        <span class="k">def</span> <span class="nf">test_phrase</span><span class="p">(</span><span class="n">phrase</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sub_cond</span> <span class="ow">in</span> <span class="n">phrase</span><span class="p">:</span>
                <span class="n">cond</span> <span class="o">=</span> <span class="n">sub_cond</span><span class="o">.</span><span class="n">rsplit</span><span class="p">()</span>
                <span class="n">prop_val</span> <span class="o">=</span> <span class="n">elem_val</span><span class="p">(</span><span class="n">cond</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">test_num</span> <span class="o">=</span> <span class="n">cond</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">prop_val</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">test_num</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">elem_value</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">test_val</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">elem_value</span><span class="p">))</span> <span class="o">+</span> <span class="n">op</span> <span class="o">+</span> <span class="n">test_val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">num</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">)</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;||&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">]</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spills</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="n">ucert</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_properties</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc</span><span class="p">)):</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">test_phrase</span><span class="p">(</span><span class="n">phrase</span><span class="p">):</span>
                    <span class="n">test_result</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">test_result</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">elem_val</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Model.add_env"><a class="viewcode-back" href="../../reference.html#gnome.model.Model.add_env">[docs]</a>    <span class="k">def</span> <span class="nf">add_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">quash</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quash</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div></div>

<span class="c1">#     def env_from_netCDF(self, filename=None, dataset=None, grid_file=None, data_file=None, _cls_list=None, **kwargs):</span>
<span class="c1">#         def attempt_from_netCDF(cls, **kwargs):</span>
<span class="c1">#             obj = None</span>
<span class="c1">#             try:</span>
<span class="c1">#                 obj = c.from_netCDF(filename=filename, dataset=dataset, grid_file=grid_file, data_file=data_file, **clskwargs)</span>
<span class="c1">#             except Exception as e:</span>
<span class="c1">#                 self.logger.warn(&#39;&#39;&#39;Class {0} could not be constituted from netCDF file</span>
<span class="c1">#                                         Exception: {1}&#39;&#39;&#39;.format(c.__name__, e))</span>
<span class="c1">#             return obj</span>
<span class="c1"># </span>
<span class="c1">#         from gnome.utilities.file_tools.data_helpers import _get_dataset</span>
<span class="c1">#         from gnome.environment.environment_objects import GriddedProp, GridVectorProp</span>
<span class="c1">#         from gnome.environment import PyGrid</span>
<span class="c1"># </span>
<span class="c1">#         if filename is not None:</span>
<span class="c1">#             data_file = filename</span>
<span class="c1">#             grid_file = filename</span>
<span class="c1"># </span>
<span class="c1">#         ds = None</span>
<span class="c1">#         dg = None</span>
<span class="c1">#         if dataset is None:</span>
<span class="c1">#             if grid_file == data_file:</span>
<span class="c1">#                 ds = dg = _get_dataset(grid_file)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 ds = _get_dataset(data_file)</span>
<span class="c1">#                 dg = _get_dataset(grid_file)</span>
<span class="c1">#         else:</span>
<span class="c1">#             if grid_file is not None:</span>
<span class="c1">#                 dg = _get_dataset(grid_file)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 dg = dataset</span>
<span class="c1">#             ds = dataset</span>
<span class="c1">#         dataset = ds</span>
<span class="c1"># </span>
<span class="c1">#         grid = kwargs.pop(&#39;grid&#39;, None)</span>
<span class="c1">#         if grid is None:</span>
<span class="c1">#             grid = PyGrid.from_netCDF(filename=filename, dataset=dg, **kwargs)</span>
<span class="c1">#             kwargs[&#39;grid&#39;] = grid</span>
<span class="c1">#         scs = copy.copy(Environment._subclasses) if _cls_list is None else _cls_list</span>
<span class="c1">#         for c in scs:</span>
<span class="c1">#             if issubclass(c, (GriddedProp, GridVectorProp)) and not any([isinstance(o, c) for o in self.environment]):</span>
<span class="c1">#                 clskwargs = copy.copy(kwargs)</span>
<span class="c1">#                 obj = None</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     req_refs = c._req_refs</span>
<span class="c1">#                 except AttributeError:</span>
<span class="c1">#                     req_refs = None</span>
<span class="c1"># </span>
<span class="c1">#                 if req_refs is not None:</span>
<span class="c1">#                     for ref, klass in req_refs.items():</span>
<span class="c1">#                         for o in self.environment:</span>
<span class="c1">#                             if isinstance(o, klass):</span>
<span class="c1">#                                 clskwargs[ref] = o</span>
<span class="c1">#                                 break</span>
<span class="c1">#                         if ref in clskwargs.keys():</span>
<span class="c1">#                             continue</span>
<span class="c1">#                         else:</span>
<span class="c1">#                             obj = attempt_from_netCDF(c, filename=filename, dataset=dataset, grid_file=grid_file, data_file=data_file, **clskwargs)</span>
<span class="c1">#                             clskwargs[ref] = obj</span>
<span class="c1">#                             self.environment.append(obj)</span>
<span class="c1"># </span>
<span class="c1">#                 obj = attempt_from_netCDF(c, filename=filename, dataset=dataset, grid_file=grid_file, data_file=data_file, **clskwargs)</span>
<span class="c1">#                 if obj is not None:</span>
<span class="c1">#                     self.environment.append(obj)</span>
<span class="c1">#                     </span>
<span class="c1">#     def ice_env_from_netCDF(self, filename=None, **kwargs):</span>
<span class="c1">#         cls_list = Environment._subclasses</span>
<span class="c1">#         ice_cls_list = self.find_by_attr(&#39;_ref_as&#39;, &#39;ice_aware&#39;, cls_list, allitems=True)</span>
<span class="c1"># #         for c in cls_list:</span>
<span class="c1"># #             if hasattr(c, &#39;_ref_as&#39;):</span>
<span class="c1"># #                 if ((not isinstance(c._ref_as, basestring) and</span>
<span class="c1"># #                         any([&#39;ice_aware&#39; in r for r in c._ref_as])) or</span>
<span class="c1"># #                         &#39;ice_aware&#39; in c._ref_as):</span>
<span class="c1"># #                     ice_cls_list.append(c)</span>
<span class="c1">#         self.env_from_netCDF(filename=filename, _cls_list=ice_cls_list, **kwargs)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012, NOAA Emergecny Response Division.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>