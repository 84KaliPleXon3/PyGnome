<!DOCTYPE html>  <html> <head>   <title>gnome.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               gnome.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>gnome.js: The WebGNOME JavaScript application.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Aliases.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">noaa</span><span class="p">.</span><span class="nx">erd</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">handleAjaxError</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">noaa</span><span class="p">.</span><span class="nx">erd</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">handleAjaxError</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  Retrieve a message object from the object `data` if the `message` key</span>
<span class="cm">  exists, annotate the message object ith an `error` value set to true</span>
<span class="cm">  if the message is an error type, and return the message object.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">parseMessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">data</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;error&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">message</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> Return a UTC date string for `timestamp`, which should be in a format</span>
<span class="cm"> acceptable to `Date.parse`.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">getUTCStringForTimestamp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toUTCString</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">timestamp</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> `TimeStep` represents a single time step of the user&#39;s actively-running</span>
<span class="cm"> model on the server.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">TimeStep</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attr</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span> <span class="o">===</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">value</span> <span class="o">=</span> <span class="nx">getUTCStringForTimestamp</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `Model` is a collection of `TimeStep` objects representing a run of</span>
<span class="cm"> the user&#39;s active model.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">model</span><span class="o">:</span> <span class="nx">TimeStep</span><span class="p">,</span>

    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeSteps</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>An array of timestamps, one for each step we expect the server to
make, passed back when we initiate a model run.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">expectedTimeSteps</span> <span class="o">||</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Optionally specify the zoom level.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">zoomLevel</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">zoomLevel</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">zoomLevel</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>If true, <code>Model</code> will request a new set of time steps from the server
on the next run. Assume we want to do this by default (i.e., at
construction time) if there are no time steps.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="nx">timeSteps</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>When initializing the model at the last time step of a generated
series, rewind to the beginning so the user can play the series
again.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">===</span> <span class="nx">timeSteps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">hasData</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Return true if the model has time step data for the step numbered</span>
<span class="cm">     `stepNum`.</span>
<span class="cm">     */</span>
    <span class="nx">hasCachedTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Return true if the server gave us a time step for step number `stepNum`.</span>
<span class="cm">     */</span>
    <span class="nx">serverHasTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">[</span><span class="nx">stepNum</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Return the timestamp the server returned for the expected step `stepNum`.</span>
<span class="cm">     Unlike `this.getTimeStep()`, this function may be called for steps that</span>
<span class="cm">     the model has not yet received from the server.</span>
<span class="cm">     */</span>
    <span class="nx">getTimestampForExpectedStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">timestamp</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">serverHasTimeStep</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">timestamp</span> <span class="o">=</span> <span class="nx">getUTCStringForTimestamp</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">[</span><span class="nx">stepNum</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">timestamp</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Handle a successful request to the server to start the model run.</span>
<span class="cm">     Events:</span>

<span class="cm">     - Triggers:</span>
<span class="cm">        - `Model.MESSAGE_RECEIVED` if the server sent a message.</span>
<span class="cm">        - `Model.RUN_BEGAN` unless we received an error message.</span>
<span class="cm">     */</span>
    <span class="nx">runSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">parseMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">expected_time_steps</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_BEGAN</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">getNextTimeStep</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Helper that performs an AJAX request to start (&quot;run&quot;) the model.</span>

<span class="cm">     Receives back an array of timestamps, one for each step the server</span>
<span class="cm">     expects to generate on subsequent requests.</span>
<span class="cm">     */</span>
    <span class="nx">doRun</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">isInvalid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">obj</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">!==</span> <span class="s2">&quot;object&quot;</span><span class="p">;</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Abort if we were asked to zoom without a valid <code>opts.rect</code> or
<code>opts.point</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">zoomLevel</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">zoomLevel</span> <span class="o">&amp;&amp;</span>
            <span class="nx">isInvalid</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">rect</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">isInvalid</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">point</span><span class="p">))</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Invalid zoom level. Please try again.&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;/run&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">opts</span><span class="p">,</span>
            <span class="nx">tryCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">retryLimit</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">runSuccess</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="nx">handleAjaxError</span>
        <span class="p">});</span>       
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Run the model.</span>

<span class="cm">     If the model is dirty, make an AJAX request to the server to initiate a</span>
<span class="cm">     model run. Otherwise request the next time step.</span>

<span class="cm">     Options:</span>
<span class="cm">     - `zoomLevel`: the user&#39;s chosen zoom level</span>
<span class="cm">     - `zoomDirection`: if the user is zooming, `Model.ZOOM_IN`,</span>
<span class="cm">         `Model.ZOOM_OUT`, otherwise `Model.ZOOM_NONE` (the default)</span>
<span class="cm">     - `runUntilTimeStep`: the time step to stop running. This value is</span>
<span class="cm">         passed to the server-side model and running will stop after the</span>
<span class="cm">         client requests the step with this number.</span>
<span class="cm">     */</span>
    <span class="nx">run</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="p">{</span>
            <span class="nx">zoomLevel</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">zoomLevel</span><span class="p">,</span>
            <span class="nx">zoomDirection</span><span class="o">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ZOOM_NONE</span><span class="p">,</span>
            <span class="nx">runUntilTimeStep</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">runUntilTimeStep</span>
        <span class="p">},</span> <span class="nx">opts</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">needToGetRunUntilStep</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">runUntilTimeStep</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">runUntilTimeStep</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">runUntilTimeStep</span><span class="p">;</span>
            <span class="nx">needToGetRunUntilStep</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">runUntilTimeStep</span> <span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">hasCachedTimeStep</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">runUntilTimeStep</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">||</span> <span class="nx">needToGetRunUntilStep</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doRun</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">getNextTimeStep</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Return the `TimeStep` object whose ID matches `self.currentTimeStep`.</span>
<span class="cm">     */</span>
    <span class="nx">getCurrentTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Set the current time step to `newStepNum`.</span>
<span class="cm">     */</span>
    <span class="nx">addTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeStepJson</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">timeStep</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TimeStep</span><span class="p">(</span><span class="nx">timeStepJson</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentTimeStep</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Set the current time step to `stepNum`.</span>

<span class="cm">     Triggers:</span>
<span class="cm">     - `Model.NEXT_TIME_STEP_READY` with the time step object for the new step.</span>
<span class="cm">     - `Model.RUN_FINISHED` if this was the step chosen to run until</span>
<span class="cm">     */</span>
    <span class="nx">setCurrentTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">=</span> <span class="nx">stepNum</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span> <span class="o">=</span> <span class="nx">stepNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runUntilTimeStep</span> <span class="o">&amp;&amp;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">runUntilTimeStep</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_FINISHED</span><span class="p">);</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">runUntilTimeStep</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
             <span class="k">return</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">NEXT_TIME_STEP_READY</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentTimeStep</span><span class="p">());</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Makes a request to the server for the next time step.</span>

<span class="cm">     Triggers:</span>
<span class="cm">     - `Model.RUN_FINISHED` if the server has no more time steps to run.</span>
<span class="cm">     */</span>
    <span class="nx">getNextTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">serverHasTimeStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_FINISHED</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The time step has already been generated and we have it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasCachedTimeStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setCurrentTimeStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Request the next step from the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Block until finished, so this and subsequent requests come
back in order.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">async</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;/next_step&#39;</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">timeStepRequestSuccess</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="nx">handleAjaxError</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">timeStepRequestSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">parseMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">time_step</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">addTimeStep</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">time_step</span><span class="p">);</span>
   <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Zoom the map from `point` in direction `direction`.</span>

<span class="cm">     Options:</span>
<span class="cm">     - `point`: an x, y coordinate, where the user clicked the map</span>
<span class="cm">     - `direction`: either `Model.ZOOM_IN` or `Model.ZOOM_OUT`</span>
<span class="cm">     */</span>
    <span class="nx">zoomFromPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">direction</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">run</span><span class="p">({</span><span class="nx">point</span><span class="o">:</span> <span class="nx">point</span><span class="p">,</span> <span class="nx">zoom</span><span class="o">:</span> <span class="nx">direction</span><span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Zoom the map from a rectangle `rect` in direction `direction`.</span>

<span class="cm">     Options:</span>
<span class="cm">     - `rect`: a rectangle consisting of two (x, y) coordinates that the</span>
<span class="cm">     user selected for the zoom operation. TODO: This should be</span>
<span class="cm">     constrained to the aspect ratio of the background image.</span>
<span class="cm">     - `direction`: either `Model.ZOOM_IN` or `Model.ZOOM_OUT`</span>
<span class="cm">     */</span>
    <span class="nx">zoomFromRect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">,</span> <span class="nx">direction</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">run</span><span class="p">({</span><span class="nx">rect</span><span class="o">:</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">zoom</span><span class="o">:</span> <span class="nx">direction</span><span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Set the current time step to 0.</span>
<span class="cm">     */</span>
    <span class="nx">rewind</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentTimeStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Clear all time step data. Used when creating a new server-side model.</span>
<span class="cm">     */</span>
    <span class="nx">clearData</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">timeSteps</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">expectedTimeSteps</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Request a new model. This destroys the current model.</span>
<span class="cm">     */</span>
    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;/create&quot;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;confirm_new=1&quot;</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span>
            <span class="nx">tryCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">retryLimit</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">createSuccess</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="nx">handleAjaxError</span>
        <span class="p">});</span>
    <span class="p">},</span>

     <span class="cm">/*</span>
<span class="cm">     Handle a successful request to the server to create a new model.</span>
<span class="cm">     */</span>
    <span class="nx">createSuccess</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">parseMessage</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>TODO: Separate error event?</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">clearData</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Class constants</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ZOOM_IN</span><span class="o">:</span> <span class="s1">&#39;zoom_in&#39;</span><span class="p">,</span>
    <span class="nx">ZOOM_OUT</span><span class="o">:</span> <span class="s1">&#39;zoom_out&#39;</span><span class="p">,</span>
    <span class="nx">ZOOM_NONE</span><span class="o">:</span> <span class="s1">&#39;zoom_none&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Class events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">CREATED</span><span class="o">:</span> <span class="s1">&#39;model:Created&#39;</span><span class="p">,</span>
    <span class="nx">RUN_BEGAN</span><span class="o">:</span> <span class="s1">&#39;model:modelRunBegan&#39;</span><span class="p">,</span>
    <span class="nx">RUN_FINISHED</span><span class="o">:</span> <span class="s1">&#39;model:modelRunFinished&#39;</span><span class="p">,</span>
    <span class="nx">RUN_ERROR</span><span class="o">:</span> <span class="s1">&#39;model:runError&#39;</span><span class="p">,</span>
    <span class="nx">NEXT_TIME_STEP_READY</span><span class="o">:</span> <span class="s1">&#39;model:nextTimeStepReady&#39;</span><span class="p">,</span>
    <span class="nx">MESSAGE_RECEIVED</span><span class="o">:</span> <span class="s1">&#39;model:messageReceived&#39;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `AjaxForm` is a helper object that handles requesting rendered form HTML from</span>
<span class="cm"> the server and posting submitted forms. Form HTML, including error output, is</span>
<span class="cm"> rendered on the server. By convention, if a form submission returns `form_html`</span>
<span class="cm"> then the form contains errors and should be displayed again. Otherwise, we</span>
<span class="cm"> assume that submission succeeded.</span>

<span class="cm"> This object handles the GET and POST requests made when a user clicks on a</span>
<span class="cm"> control, typically using one of the control views (e.g., `TreeControlView`),</span>
<span class="cm"> that displays a form, or when the user submits a form. The form HTML is</span>
<span class="cm"> displayed in a modal view using `ModalFormView`.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">AjaxForm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">collection</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">collection</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Mix Backbone.js event methods into <code>AjaxForm</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span> <span class="o">=</span> <span class="s1">&#39;ajaxForm:messageReceived&#39;</span><span class="p">;</span>
<span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">CHANGED</span> <span class="o">=</span> <span class="s1">&#39;ajaxForm:changed&#39;</span><span class="p">;</span>

<span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     Refresh this form from the server&#39;s JSON response.</span>
<span class="cm">     */</span>
    <span class="nx">parse</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">parseMessage</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="s1">&#39;form_html&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">form_html</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">form_html</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Make an AJAX request for this `AjaxForm`, merging `opts` into the options</span>
<span class="cm">     object passed to $.ajax. By default, this method uses a GET operation.</span>
<span class="cm">     */</span>
    <span class="nx">makeRequest</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
            <span class="nx">tryCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">retryLimit</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="nx">success</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="nx">handleAjaxError</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Get the HTML for this form.</span>
<span class="cm">     */</span>
    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Submit using `opts` and refresh this `AjaxForm` from JSON in the response.</span>
<span class="cm">     The assumption here is that `data` and `url` have been provided in `opts`</span>
<span class="cm">     and we&#39;re just passing them along to the `makeRequest()` method.</span>
<span class="cm">     */</span>
    <span class="nx">submit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">opts</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">makeRequest</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> `MessageView` is responsible for displaying messages sent back from the server</span>
<span class="cm"> during AJAX form submissions. These are non-form error conditions, usually,</span>
<span class="cm"> but can also be success messages.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">MessageView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span>
            <span class="nx">Model</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ajaxForms</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span>
            <span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">MESSAGE_RECEIVED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">displayMessage</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">alertDiv</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div .alert-&#39;</span> <span class="o">+</span> <span class="nx">message</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="nx">alertDiv</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">alertDiv</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;span.message&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
            <span class="nx">alertDiv</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `MapView` represents the visual map and is reponsible for animating frames</span>
<span class="cm"> for each time step rendered by the server</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">MapView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">frameClass</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">frameClass</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">activeFrameClass</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">activeFrameClass</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">placeholderEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">placeholderEl</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">createPlaceholderCopy</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">makeImagesClickable</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">NEXT_TIME_STEP_READY</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">nextTimeStepReady</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelRunError</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_FINISHED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelRunFinished</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelCreated</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">isPaused</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isStopped</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isPlaying</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setPaused</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">PAUSED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setStopped</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">STOPPED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setPlaying</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapView</span><span class="p">.</span><span class="nx">PLAYING</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">createPlaceholderCopy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">placeholderCopy</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">placeholderEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span>
            <span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">clone</span><span class="p">().</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">)).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">removePlaceholderCopy</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">placeholderCopy</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">makeImagesClickable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;clickEnabled&#39;</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">MAP_WAS_CLICKED</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">x</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span>
                    <span class="nx">y</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">makeActiveImageClickable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveImage</span><span class="p">();</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s1">&#39;clickEnabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">makeActiveImageSelectable</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveImage</span><span class="p">();</span>
        <span class="nx">image</span><span class="p">.</span><span class="nx">selectable</span><span class="p">({</span>
            <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">startPosition</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span><span class="p">};</span>
            <span class="p">},</span>
            <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">selectable</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">DRAGGING_FINISHED</span><span class="p">,</span> <span class="p">[</span>
                        <span class="nx">_this</span><span class="p">.</span><span class="nx">startPosition</span><span class="p">,</span>
                        <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">pageY</span><span class="p">}</span>
                    <span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">getActiveImage</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span> <span class="o">+</span> <span class="s2">&quot; &gt; img.active&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getImageForTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;img[data-id=&quot;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">timeStepIsLoaded</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImageForTimeStep</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">step</span> <span class="o">&amp;&amp;</span> <span class="nx">step</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Show the image for time step with ID `stepNum`.</span>

<span class="cm">     Triggers:</span>
<span class="cm">        - `MapView.FRAME_CHANGED` after the image has loaded.</span>
<span class="cm">     */</span>
    <span class="nx">showImageForTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Show the map div if this is the first image of the run.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">map</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">map</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">stepImage</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImageForTimeStep</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">otherImages</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">not</span><span class="p">(</span><span class="nx">stepImage</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Hide all other images in the map div.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">otherImages</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>
        <span class="nx">otherImages</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">activeFrameClass</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The image isn't loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">stepImage</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;An animation error occurred. Please refresh.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">stepImage</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">activeFrameClass</span><span class="p">);</span>
        <span class="nx">stepImage</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">FRAME_CHANGED</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">addImageForTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;&lt;img&gt;&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">({</span>
            <span class="s1">&#39;class&#39;</span><span class="o">:</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data-id&#39;</span><span class="o">:</span> <span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">src</span><span class="o">:</span> <span class="nx">timeStep</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
        <span class="p">}).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;display&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">);</span>

        <span class="nx">img</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">(</span><span class="nx">img</span><span class="p">).</span><span class="nx">imagesLoaded</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_this</span><span class="p">.</span><span class="nx">showImageForTimeStep</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="p">[</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">addTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">placeholderCopy</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">removePlaceholderCopy</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">imageExists</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getImageForTimeStep</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>We must be playing a cached model run because the image already
exists. In all other cases the image should NOT exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">imageExists</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">showImageForTimeStep</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="p">[</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">]);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">addImageForTimeStep</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Clear out the current frames.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">empty</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">getSize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveImage</span><span class="p">();</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">height</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">(),</span> <span class="nx">width</span><span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">()};</span>
    <span class="p">},</span>

    <span class="nx">getPosition</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getActiveImage</span><span class="p">().</span><span class="nx">position</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">getBoundingBox</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getPosition</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getSize</span><span class="p">();</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span><span class="p">},</span>
            <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">size</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">pos</span><span class="p">.</span><span class="nx">top</span> <span class="o">+</span> <span class="nx">size</span><span class="p">.</span><span class="nx">height</span><span class="p">}</span>
        <span class="p">];</span>
    <span class="p">},</span>

    <span class="nx">setZoomingInCursor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;zooming-in&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setZoomingOutCursor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;zooming-out&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setRegularCursor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;zooming-out&#39;</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;zooming-in&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getRect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newStartPosition</span><span class="p">,</span> <span class="nx">newEndPosition</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Do a shallow object copy, so we don't modify the original.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">x</span> <span class="o">||</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newStartPosition</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
            <span class="nx">newEndPosition</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">newStartPosition</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
            <span class="nx">newEndPosition</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">start</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">newStartPosition</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">newEndPosition</span><span class="p">};</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Adjust a selection rectangle so that it fits within the bounding box.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">getAdjustedRect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">adjustedRect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRect</span><span class="p">(</span><span class="nx">rect</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">bbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getBoundingBox</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>TOOD: This looks wrong. Add tests.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">adjustedRect</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">adjustedRect</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isPositionInsideMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">bbox</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getBoundingBox</span><span class="p">();</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span> <span class="o">&amp;&amp;</span>
            <span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">isRectInsideMap</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rect</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_rect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRect</span><span class="p">(</span><span class="nx">rect</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isPositionInsideMap</span><span class="p">(</span><span class="nx">_rect</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">isPositionInsideMap</span><span class="p">(</span><span class="nx">_rect</span><span class="p">.</span><span class="nx">end</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">nextTimeStepReady</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addTimeStep</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getCurrentTimeStep</span><span class="p">());</span>
    <span class="p">},</span>

    <span class="nx">modelRunError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">modelRunFinished</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">modelCreated</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">createPlaceholderCopy</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Statuses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">PAUSED</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">STOPPED</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">PLAYING</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">DRAGGING_FINISHED</span><span class="o">:</span> <span class="s1">&#39;mapView:draggingFinished&#39;</span><span class="p">,</span>
    <span class="nx">REFRESH_FINISHED</span><span class="o">:</span> <span class="s1">&#39;mapView:refreshFinished&#39;</span><span class="p">,</span>
    <span class="nx">PLAYING_FINISHED</span><span class="o">:</span> <span class="s1">&#39;mapView:playingFinished&#39;</span><span class="p">,</span>
    <span class="nx">FRAME_CHANGED</span><span class="o">:</span> <span class="s1">&#39;mapView:frameChanged&#39;</span><span class="p">,</span>
    <span class="nx">MAP_WAS_CLICKED</span><span class="o">:</span> <span class="s1">&#39;mapView:mapWasClicked&#39;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `TreeView` is a representation of the user&#39;s current model displayed as a tree</span>
<span class="cm"> of items that the user may click or double-click on to display add/edit forms</span>
<span class="cm"> for model settings, movers and spills.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">TreeView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">treeEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">treeEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tree</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">setupDynatree</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Event handlers</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ajaxForms</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ajaxFormChanged</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">reload</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setupDynatree</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">treeEl</span><span class="p">).</span><span class="nx">dynatree</span><span class="p">({</span>
            <span class="nx">onActivate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">TreeView</span><span class="p">.</span><span class="nx">ITEM_ACTIVATED</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">onPostInit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isReloading</span><span class="p">,</span> <span class="nx">isError</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Fire events for a tree that was reloaded from cookies.
isReloading is true if status was read from existing cookies.
isError is only used in Ajax mode</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">this</span><span class="p">.</span><span class="nx">reactivate</span><span class="p">();</span>
            <span class="p">},</span>
            <span class="nx">onDblClick</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">TreeView</span><span class="p">.</span><span class="nx">ITEM_DOUBLE_CLICKED</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
            <span class="p">},</span>
            <span class="nx">initAjax</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">url</span>
            <span class="p">},</span>
            <span class="nx">persist</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     An event handler called when an `AjaxForm` in `this.forms` changes.</span>

<span class="cm">     If a form was submitted successfully, we need to reload the tree view in</span>
<span class="cm">     case new items were added.</span>
<span class="cm">     */</span>
    <span class="nx">ajaxFormChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ajaxForm</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">formHtml</span> <span class="o">=</span> <span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">form_html</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>This field will be null on a successful submit.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">formHtml</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">getActiveItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">dynatree</span><span class="p">(</span><span class="s2">&quot;getActiveNode&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">hasItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">dynatree</span><span class="p">(</span><span class="s1">&#39;getTree&#39;</span><span class="p">).</span><span class="nx">selectKey</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">reload</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">tree</span><span class="p">.</span><span class="nx">dynatree</span><span class="p">(</span><span class="s1">&#39;getTree&#39;</span><span class="p">).</span><span class="nx">reload</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">ITEM_ACTIVATED</span><span class="o">:</span> <span class="s1">&#39;gnome:treeItemActivated&#39;</span><span class="p">,</span>
    <span class="nx">ITEM_DOUBLE_CLICKED</span><span class="o">:</span> <span class="s1">&#39;gnome:treeItemDoubleClicked&#39;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `TreeControlView` is a button bar that sits above the tree view and allows</span>
<span class="cm"> the user to add, edit and remove settings values, movers and spills using</span>
<span class="cm"> button clicks.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">TreeControlView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">addButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">addButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">removeButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">removeButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">settingsButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">settingsButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Controls that require the user to select an item in the TreeView.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">itemControls</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">removeButtonEl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">settingsButtonEl</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">disableControls</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setupClickEvents</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">treeView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">TreeView</span><span class="p">.</span><span class="nx">ITEM_ACTIVATED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">treeItemActivated</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setupClickEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">clickEvents</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">addButtonEl</span><span class="p">,</span> <span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">ADD_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">removeButtonEl</span><span class="p">,</span> <span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">REMOVE_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">settingsButtonEl</span><span class="p">,</span> <span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">SETTINGS_BUTTON_CLICKED</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="nx">clickEvents</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customEvent</span><span class="p">,</span> <span class="nx">element</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">_this</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">customEvent</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">treeItemActivated</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">enableControls</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">enableControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">itemControls</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">disableControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">itemControls</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ADD_BUTTON_CLICKED</span><span class="o">:</span> <span class="s1">&#39;gnome:addItemButtonClicked&#39;</span><span class="p">,</span>
    <span class="nx">REMOVE_BUTTON_CLICKED</span><span class="o">:</span> <span class="s1">&#39;gnome:removeItemButtonClicked&#39;</span><span class="p">,</span>
    <span class="nx">SETTINGS_BUTTON_CLICKED</span><span class="o">:</span> <span class="s1">&#39;gnome:itemSettingsButtonClicked&#39;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `MapControlView` is a button toolbar that sits above the map and allows the</span>
<span class="cm"> user to stop, start, skip to the end, skip to the beginning, and scrub between</span>
<span class="cm"> frames of an animation generated during a model run.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">MapControlView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">containerEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">containerEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">backButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">backButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">forwardButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">forwardButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">zoomInButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">zoomInButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">zoomOutButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">zoomOutButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">moveButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">moveButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fullscreenButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">fullscreenButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">resizeButtonEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">resizeButtonEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">timeEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">timeEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mapView</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Controls whose state, either enabled or disabled, is related to whether
or not an animation is playing. The resize and full screen buttons
are intentionally excluded.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">controls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">backButtonEl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">forwardButtonEl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">moveButtonEl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">zoomInButtonEl</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">zoomOutButtonEl</span>
        <span class="p">];</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_STOPPED</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>

        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">({</span>
            <span class="nx">start</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderStarted</span><span class="p">,</span>
            <span class="nx">change</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderChanged</span><span class="p">,</span>
            <span class="nx">slide</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderMoved</span><span class="p">,</span>
            <span class="nx">disabled</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setTimeSteps</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setupClickEvents</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_BEGAN</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">runBegan</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelRunError</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_FINISHED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelRunFinished</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">CREATED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelCreated</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">FRAME_CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mapViewFrameChanged</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setupClickEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">clickEvents</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">PLAY_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">backButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">BACK_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">forwardButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">FORWARD_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">zoomInButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ZOOM_IN_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">zoomOutButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ZOOM_OUT_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">moveButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">MOVE_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">fullscreenButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">FULLSCREEN_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">RESIZE_BUTTON_CLICKED</span><span class="p">],</span>
            <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">PAUSE_BUTTON_CLICKED</span><span class="p">]</span>
        <span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>TODO: This probably leaks memory, so do something else here, like
looking up the right <code>customEvent</code> for the element.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="nx">clickEvents</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">customEvent</span><span class="p">,</span> <span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">button</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">button</span><span class="p">).</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">customEvent</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">sliderStarted</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">PAUSE_BUTTON_CLICKED</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">sliderChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">SLIDER_CHANGED</span><span class="p">,</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">sliderMoved</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getTimestampForExpectedStep</span><span class="p">(</span><span class="nx">ui</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Slider changed to invalid time step: &#39;</span> <span class="o">+</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">SLIDER_MOVED</span><span class="p">,</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">runBegan</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">dirty</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>TODO: Is this really what we want to do here?</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setTimeSteps</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">mapViewFrameChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">timeStep</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getCurrentTimeStep</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setTimeStep</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">timeStep</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">));</span>
    <span class="p">},</span>

    <span class="nx">stop</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">enableControls</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">modelRunError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">modelRunFinished</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">modelCreated</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">setStopped</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_STOPPED</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">setPlaying</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_PLAYING</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">setPaused</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_PAUSED</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">setForward</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_FORWARD</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setBack</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_BACK</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setZoomingIn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_ZOOMING_IN</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setZoomingOut</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_ZOOMING_OUT</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">setTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">stepNum</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setTime</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeEl</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">setTimeSteps</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">timeSteps</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="nx">timeSteps</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">switchToFullscreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fullscreenButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeButtonEl</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">switchToNormalScreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resizeButtonEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fullscreenButtonEl</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">isPlaying</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_PLAYING</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isStopped</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_STOPPED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isPaused</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_PAUSED</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isForward</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_PLAYING</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isBack</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_BACK</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isZoomingIn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_ZOOMING_IN</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">isZoomingOut</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">STATUS_ZOOMING_OUT</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Toggle the slider. <code>toggleOn</code> should be either <code>MapControlView.ON</code>
or <code>MapControlView.OFF</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toggleSlider</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">toggle</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">toggle</span> <span class="o">!==</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ON</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;option&#39;</span><span class="p">,</span> <span class="s1">&#39;disabled&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Toggle a control. <code>toggleOn</code> should be either <code>MapControlView.ON</code>
or <code>MapControlView.OFF</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">toggleControl</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">,</span> <span class="nx">toggle</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">toggle</span> <span class="o">===</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ON</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">$</span><span class="p">(</span><span class="nx">buttonEl</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;disabled&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Enable or disable specified controls.</span>

<span class="cm">     If `this.sliderEl` is present in `controls`, use the `this.toggleSlider`</span>
<span class="cm">     function to toggle it.</span>

<span class="cm">     If `controls` is empty, apply `toggle` to all controls in `this.controls`.</span>

<span class="cm">     Options:</span>
<span class="cm">     - `controls`: an array of HTML elements to toggle</span>
<span class="cm">     - `toggle`: either `MapControlView.OFF` or `MapControlView.ON`.</span>
<span class="cm">     */</span>
    <span class="nx">toggleControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controls</span><span class="p">,</span> <span class="nx">toggle</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span> <span class="o">&amp;&amp;</span> <span class="nx">controls</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">controls</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">toggleSlider</span><span class="p">(</span><span class="nx">toggle</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">without</span><span class="p">(</span><span class="nx">controls</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">_this</span><span class="p">.</span><span class="nx">toggleControl</span><span class="p">(</span><span class="nx">button</span><span class="p">,</span> <span class="nx">toggle</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">toggleSlider</span><span class="p">(</span><span class="nx">toggle</span><span class="p">);</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">controls</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_this</span><span class="p">.</span><span class="nx">toggleControl</span><span class="p">(</span><span class="nx">button</span><span class="p">,</span> <span class="nx">toggle</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">enableControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">toggleControls</span><span class="p">(</span><span class="nx">controls</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ON</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">disableControls</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">controls</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">toggleControls</span><span class="p">(</span><span class="nx">controls</span><span class="p">,</span> <span class="nx">MapControlView</span><span class="p">.</span><span class="nx">OFF</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getTimeStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="s1">&#39;00:00&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">disableControls</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setTimeStep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sliderEl</span><span class="p">).</span><span class="nx">slider</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">enableControls</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">playButtonEl</span><span class="p">]);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Constants</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ON</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">OFF</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">PLAY_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:playButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">PAUSE_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:pauseButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">BACK_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:backButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">FORWARD_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:forwardButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">ZOOM_IN_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:zoomInButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">ZOOM_OUT_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:zoomOutButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">MOVE_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:moveButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">FULLSCREEN_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:fullscreenButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">RESIZE_BUTTON_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:resizeButtonClicked&quot;</span><span class="p">,</span>
    <span class="nx">SLIDER_CHANGED</span><span class="o">:</span> <span class="s2">&quot;gnome:sliderChanged&quot;</span><span class="p">,</span>
    <span class="nx">SLIDER_MOVED</span><span class="o">:</span> <span class="s2">&quot;gnome:sliderMoved&quot;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Statuses</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">STATUS_STOPPED</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">STATUS_PLAYING</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">STATUS_PAUSED</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">STATUS_BACK</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nx">STATUS_FORWARD</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nx">STATUS_ZOOMING_IN</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="nx">STATUS_ZOOMING_OUT</span><span class="o">:</span> <span class="mi">6</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `ModalFormView` is responsible for displaying HTML forms retrieved</span>
<span class="cm"> from and submitted to the server using an `AjaxForm object. `ModalFormView`</span>
<span class="cm"> displays an HTML form in a modal &quot;window&quot; over the page using the rendered HTML</span>
<span class="cm"> returned by the server. It listens to &#39;change&#39;events on a bound `AjaxForm` and</span>
<span class="cm"> refreshes itself when that event fires.</span>

<span class="cm"> The view is designed to handle multi-step forms implemented purely in</span>
<span class="cm"> JavaScript (and HTML) using data- properties on DOM elements. The server</span>
<span class="cm"> returns one rendered form, but may split its content into several &lt;div&gt;s, each</span>
<span class="cm"> with a `data-step` property. If a form is structured this way, the user of the</span>
<span class="cm"> JavaScript application will see it as a multi-step form with &quot;next,&quot; &quot;back&quot;</span>
<span class="cm"> and (at the end) a &quot;save&quot; or &quot;create&quot; button (the label is given by the server,</span>
<span class="cm"> but whatever it is, this is the button that signals final submission of the</span>
<span class="cm"> form).</span>

<span class="cm"> Submitting a form from `ModalFormView` serializes the form HTML and sends it to</span>
<span class="cm"> a bound `AjaxForm` model object, which then handles settings up the AJAX</span>
<span class="cm"> request for a POST.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">ModalFormView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">formContainerEl</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">AjaxForm</span><span class="p">.</span><span class="nx">CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ajaxFormChanged</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Bind listeners to the container, using <code>on()</code>, so they persist if
the underlying form elements are replaced.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; .btn-primary&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">submit</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; .btn-next&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">goToNextStep</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; .btn-prev&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">goToPreviousStep</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">ajaxFormChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ajaxForm</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">formHtml</span> <span class="o">=</span> <span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">form_html</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">formHtml</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span><span class="p">(</span><span class="nx">formHtml</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.modal&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">modal</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Reload this form&#39;s HTML by initiating an AJAX request via this view&#39;s</span>
<span class="cm">     bound `AjaxForm`. If the request is successful, this `ModelFormView` will</span>
<span class="cm">     fire its `ajaxFormChanged` event handler.</span>
<span class="cm">     */</span>
    <span class="nx">reload</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">getForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getFirstStepWithError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">().</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;multistep&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">errorDiv</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;div.control-group.error&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">stepDiv</span> <span class="o">=</span> <span class="nx">errorDiv</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s1">&#39;div.step&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">stepDiv</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step</span> <span class="o">=</span> <span class="nx">stepDiv</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-step&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">step</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">getStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div[data-step=&quot;&#39;</span> <span class="o">+</span> <span class="nx">stepNum</span>  <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">previousStepExists</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="nx">stepNum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">nextStepExists</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">stepNum</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">getStep</span><span class="p">(</span><span class="nx">stepNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">goToStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$form</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;multistep&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">stepDiv</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.step[data-step=&quot;&#39;</span> <span class="o">+</span> <span class="nx">stepNum</span> <span class="o">+</span> <span class="s1">&#39;&quot;]&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">stepDiv</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">otherStepDivs</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.step&#39;</span><span class="p">);</span>
        <span class="nx">otherStepDivs</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="nx">otherStepDivs</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
        <span class="nx">stepDiv</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="nx">stepDiv</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>

        <span class="kd">var</span> <span class="nx">prevButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.btn-prev&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">nextButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.btn-next&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">saveButton</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.btn-primary&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">previousStepExists</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">prevButton</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">prevButton</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nextStepExists</span><span class="p">(</span><span class="nx">stepNum</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">nextButton</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
            <span class="nx">saveButton</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">nextButton</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
        <span class="nx">saveButton</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">goToNextStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$form</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;multistep&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">activeStepDiv</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.step.active&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">currentStep</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">activeStepDiv</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-step&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">goToStep</span><span class="p">(</span><span class="nx">currentStep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">goToPreviousStep</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$form</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="s1">&#39;multistep&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">activeStep</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;div.step.active&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">currentStep</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">activeStep</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-step&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">goToStep</span><span class="p">(</span><span class="nx">currentStep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">submit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">submit</span><span class="p">({</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span>
            <span class="nx">url</span><span class="o">:</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Replace this form with the form in `html`, an HTML string rendered by the</span>
<span class="cm">     server. Recreate any jQuery UI datepickers on the form if necessary.</span>
<span class="cm">     If there is an error in the form, load the step with errors.</span>
<span class="cm">     */</span>
    <span class="nx">refresh</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">prependTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;.date&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">({</span>
            <span class="nx">changeMonth</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">changeYear</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">stepWithError</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getFirstStepWithError</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">stepWithError</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">goToStep</span><span class="p">(</span><span class="nx">stepWithError</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">clear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">empty</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> This is a non-AJAX-enabled modal form object to support the &quot;add mover&quot; form,</span>
<span class="cm"> which just allows the user to choose a type of mover to add (i.e., another</span>
<span class="cm"> form to display).</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">AddMoverFormView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">formContainerEl</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Bind listeners to the container, using <code>on()</code>, so they persist.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$container</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; .btn-primary&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">submit</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">getForm</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;form&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">modal</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">hide</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s1">&#39;hide&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">submit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">$form</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getForm</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">moverType</span> <span class="o">=</span> <span class="nx">$form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;select[name=&quot;mover_type&quot;]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">moverType</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">AddMoverFormView</span><span class="p">.</span><span class="nx">MOVER_CHOSEN</span><span class="p">,</span> <span class="nx">moverType</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MOVER_CHOSEN</span><span class="o">:</span> <span class="s1">&#39;addMoverFormView:moverChosen&#39;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `MenuView` handles the drop-down menus on the top of the page. The object</span>
<span class="cm"> listens for click events on menu items and fires specialized events, like</span>
<span class="cm">  RUN_ITEM_CLICKED, which an `AppView` object listens for.</span>

<span class="cm">  Most of these functions exist elsewhere in the application and `AppView`</span>
<span class="cm">  calls the appropriate method for whatever functionality the user invoked.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">MenuView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Top-level drop-downs</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">modelDropdownEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">modelDropdownEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">runDropdownEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">runDropdownEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">helpDropdownEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">helpDropdownEl</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Drop-down children</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">newItemEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">newItemEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">runItemEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">runItemEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">stepItemEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">stepItemEl</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">runUntilItemEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">runUntilItemEl</span><span class="p">;</span>

        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">newItemEl</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">newItemClicked</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runItemEl</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runItemClicked</span><span class="p">);</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runUntilItemEl</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runUntilItemClicked</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">newItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">modelDropdownEl</span><span class="p">).</span><span class="nx">dropdown</span><span class="p">(</span><span class="s1">&#39;toggle&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">NEW_ITEM_CLICKED</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">runItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runDropdownEl</span><span class="p">).</span><span class="nx">dropdown</span><span class="p">(</span><span class="s1">&#39;toggle&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">RUN_ITEM_CLICKED</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">runUntilItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">runDropdownEl</span><span class="p">).</span><span class="nx">dropdown</span><span class="p">(</span><span class="s1">&#39;toggle&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">RUN_UNTIL_ITEM_CLICKED</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Events</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">NEW_ITEM_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:newMenuItemClicked&quot;</span><span class="p">,</span>
    <span class="nx">RUN_ITEM_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:runMenuItemClicked&quot;</span><span class="p">,</span>
    <span class="nx">RUN_UNTIL_ITEM_CLICKED</span><span class="o">:</span> <span class="s2">&quot;gnome:runUntilMenuItemClicked&quot;</span>
<span class="p">});</span>


<span class="cm">/*</span>
<span class="cm"> `AppView` acts as a controller, listening to delegate views and models for</span>
<span class="cm"> events and coordinating any necessary changes.</span>

<span class="cm"> As a design principle, `AppView` should only handle events triggered by models</span>
<span class="cm"> and views that *require* coordination. Otherwise, views should listen directly</span>
<span class="cm"> to a specific model (or another view) and handle updating themselves without</span>
<span class="cm"> assistance from `AppView`. This convention is in-progress and could be better</span>
<span class="cm"> enforced.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">AppView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">apiRoot</span> <span class="o">=</span> <span class="s2">&quot;/model&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Initialize the model with any previously-generated time step data the
server had available.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Model</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">generatedTimeSteps</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiRoot</span><span class="p">,</span>
            <span class="nx">expectedTimeSteps</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">expectedTimeSteps</span><span class="p">,</span>
            <span class="nx">currentTimeStep</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">currentTimeStep</span>
        <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>An object holding all of our <code>AjaxForm</code> instances, keyed to the name
of the form as passed by the server in <code>this.options.formUrls</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">forms</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">forms</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>An object holding all of the <code>ModelFormView</code> instances, keyed to the
name of the form as passed by the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">formViews</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Create an <code>AjaxForm</code> and bind it to a <code>ModalFormView</code> for each form
URL the server gave us.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">formUrls</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">_this</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AjaxForm</span><span class="p">({</span>
                <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
                <span class="nx">collection</span><span class="o">:</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">forms</span>
            <span class="p">});</span>

            <span class="nx">_this</span><span class="p">.</span><span class="nx">formViews</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ModalFormView</span><span class="p">({</span>
                <span class="nx">ajaxForm</span><span class="o">:</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>AJAX forms use this name as their HTML ID.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">),</span>
                <span class="nx">formContainerEl</span><span class="o">:</span> <span class="nx">_this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">formContainerEl</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">addMoverFormView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AddMoverFormView</span><span class="p">({</span>
            <span class="nx">el</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#add_mover&#39;</span><span class="p">),</span>
            <span class="nx">formContainerEl</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">formContainerEl</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">formViews</span><span class="p">[</span><span class="s1">&#39;add_mover&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">addMoverFormView</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">menuView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MenuView</span><span class="p">({</span>
            <span class="nx">modelDropDownEl</span><span class="o">:</span> <span class="s2">&quot;#file-drop&quot;</span><span class="p">,</span>
            <span class="nx">runDropdownEl</span><span class="o">:</span> <span class="s2">&quot;#run-drop&quot;</span><span class="p">,</span>
            <span class="nx">helpDropdownEl</span><span class="o">:</span> <span class="s2">&quot;#help-drop&quot;</span><span class="p">,</span>
            <span class="nx">newItemEl</span><span class="o">:</span> <span class="s2">&quot;#menu-new&quot;</span><span class="p">,</span>
            <span class="nx">runItemEl</span><span class="o">:</span> <span class="s2">&quot;#menu-run&quot;</span><span class="p">,</span>
            <span class="nx">stepItemEl</span><span class="o">:</span> <span class="s2">&quot;#menu-step&quot;</span><span class="p">,</span>
            <span class="nx">runUntilItemEl</span><span class="o">:</span> <span class="s2">&quot;#menu-run-until&quot;</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">sidebarEl</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">sidebarEl</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">treeView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TreeView</span><span class="p">({</span>
            <span class="nx">treeEl</span><span class="o">:</span> <span class="s2">&quot;#tree&quot;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;/tree&quot;</span><span class="p">,</span>
            <span class="nx">ajaxForms</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">forms</span><span class="p">,</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">treeControlView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TreeControlView</span><span class="p">({</span>
            <span class="nx">addButtonEl</span><span class="o">:</span> <span class="s2">&quot;#add-button&quot;</span><span class="p">,</span>
            <span class="nx">removeButtonEl</span><span class="o">:</span> <span class="s2">&quot;#remove-button&quot;</span><span class="p">,</span>
            <span class="nx">settingsButtonEl</span><span class="o">:</span> <span class="s2">&quot;#settings-button&quot;</span><span class="p">,</span>
            <span class="nx">treeView</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">treeView</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MapView</span><span class="p">({</span>
            <span class="nx">mapEl</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mapEl</span><span class="p">,</span>
            <span class="nx">placeholderEl</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mapPlaceholderEl</span><span class="p">,</span>
            <span class="nx">frameClass</span><span class="o">:</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span>
            <span class="nx">activeFrameClass</span><span class="o">:</span> <span class="s1">&#39;active&#39;</span><span class="p">,</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MapControlView</span><span class="p">({</span>
            <span class="nx">sliderEl</span><span class="o">:</span> <span class="s2">&quot;#slider&quot;</span><span class="p">,</span>
            <span class="nx">playButtonEl</span><span class="o">:</span> <span class="s2">&quot;#play-button&quot;</span><span class="p">,</span>
            <span class="nx">pauseButtonEl</span><span class="o">:</span> <span class="s2">&quot;#pause-button&quot;</span><span class="p">,</span>
            <span class="nx">backButtonEl</span><span class="o">:</span> <span class="s2">&quot;#back-button&quot;</span><span class="p">,</span>
            <span class="nx">forwardButtonEl</span><span class="o">:</span> <span class="s2">&quot;#forward-button&quot;</span><span class="p">,</span>
            <span class="nx">zoomInButtonEl</span><span class="o">:</span> <span class="s2">&quot;#zoom-in-button&quot;</span><span class="p">,</span>
            <span class="nx">zoomOutButtonEl</span><span class="o">:</span> <span class="s2">&quot;#zoom-out-button&quot;</span><span class="p">,</span>
            <span class="nx">moveButtonEl</span><span class="o">:</span> <span class="s2">&quot;#move-button&quot;</span><span class="p">,</span>
            <span class="nx">fullscreenButtonEl</span><span class="o">:</span> <span class="s2">&quot;#fullscreen-button&quot;</span><span class="p">,</span>
            <span class="nx">resizeButtonEl</span><span class="o">:</span> <span class="s2">&quot;#resize-button&quot;</span><span class="p">,</span>
            <span class="nx">timeEl</span><span class="o">:</span> <span class="s2">&quot;#time&quot;</span><span class="p">,</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiRoot</span> <span class="o">+</span> <span class="s1">&#39;/time_steps&#39;</span><span class="p">,</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
            <span class="nx">mapView</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">messageView</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MessageView</span><span class="p">({</span>
            <span class="nx">model</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">,</span>
            <span class="nx">ajaxForms</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">forms</span>
        <span class="p">});</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setupEventHandlers</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">setupEventHandlers</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">RUN_ERROR</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">modelRunError</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">treeView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">TreeView</span><span class="p">.</span><span class="nx">ITEM_DOUBLE_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">treeItemDoubleClicked</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">treeControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">ADD_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">addButtonClicked</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">treeControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">REMOVE_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeButtonClicked</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">treeControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">TreeControlView</span><span class="p">.</span><span class="nx">SETTINGS_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">settingsButtonClicked</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">PLAY_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">playButtonClicked</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">PAUSE_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ZOOM_IN_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">enableZoomIn</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">ZOOM_OUT_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">enableZoomOut</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">SLIDER_CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderChanged</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">SLIDER_MOVED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">sliderMoved</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">BACK_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jumpToFirstFrame</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">FORWARD_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">jumpToLastFrame</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">FULLSCREEN_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">useFullscreen</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapControlView</span><span class="p">.</span><span class="nx">RESIZE_BUTTON_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">disableFullscreen</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">PLAYING_FINISHED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">stopAnimation</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">DRAGGING_FINISHED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">zoomIn</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">FRAME_CHANGED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">frameChanged</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MapView</span><span class="p">.</span><span class="nx">MAP_WAS_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">zoomOut</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">menuView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">NEW_ITEM_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">newMenuItemClicked</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">menuView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">RUN_ITEM_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">runMenuItemClicked</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">menuView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">MenuView</span><span class="p">.</span><span class="nx">RUN_UNTIL_ITEM_CLICKED</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">runUntilMenuItemClicked</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">addMoverFormView</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">AddMoverFormView</span><span class="p">.</span><span class="nx">MOVER_CHOSEN</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">moverChosen</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">modelRunError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">messageView</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
            <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;Model run failed.&#39;</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">isValidFormType</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">formType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formTypes</span><span class="p">,</span> <span class="nx">formType</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">runMenuItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">({});</span>
    <span class="p">},</span>

    <span class="nx">runUntilMenuItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">fetchForm</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;run_until&#39;</span><span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">newMenuItemClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">confirm</span><span class="p">(</span><span class="s2">&quot;Reset model?&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">play</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">disableControls</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">enableControls</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">pauseButtonEl</span><span class="p">]);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setPlaying</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setPlaying</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">run</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">playButtonClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">({});</span>
    <span class="p">},</span>

    <span class="nx">enableZoomIn</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">hasData</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setZoomingIn</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">makeActiveImageClickable</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">makeActiveImageSelectable</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setZoomingInCursor</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">enableZoomOut</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">hasData</span><span class="p">()</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setZoomingOut</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">makeActiveImageClickable</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setZoomingOutCursor</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">stopAnimation</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setStopped</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">zoomIn</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">startPosition</span><span class="p">,</span> <span class="nx">endPosition</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">endPosition</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="p">{</span><span class="nx">start</span><span class="o">:</span> <span class="nx">startPosition</span><span class="p">,</span> <span class="nx">end</span><span class="o">:</span> <span class="nx">endPosition</span><span class="p">};</span>
            <span class="kd">var</span> <span class="nx">isInsideMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">isRectInsideMap</span><span class="p">(</span><span class="nx">rect</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>If we are at zoom level 0 and there is no map portion outside of
the visible area, then adjust the coordinates of the selected
rectangle to the on-screen pixel bounds.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isInsideMap</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">zoomLevel</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">rect</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">getAdjustedRect</span><span class="p">(</span><span class="nx">rect</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">zoomFromRect</span><span class="p">(</span><span class="nx">rect</span><span class="p">,</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ZOOM_IN</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">zoomFromPoint</span><span class="p">(</span><span class="nx">startPosition</span><span class="p">,</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ZOOM_IN</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setRegularCursor</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">zoomOut</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">rewind</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">zoomFromPoint</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ZOOM_OUT</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setRegularCursor</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">pause</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">setPaused</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">enableControls</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">sliderChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newStepNum</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>We're advancing in an animation, so ignore the change. Otherwise
the user just dragged the slider to a new position.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">newStepNum</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">currentTimeStep</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>If the model and map view have the time step, display it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">hasCachedTimeStep</span><span class="p">(</span><span class="nx">newStepNum</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">timeStepIsLoaded</span><span class="p">(</span><span class="nx">newStepNum</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">setCurrentTimeStep</span><span class="p">(</span><span class="nx">newStepNum</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Otherwise, we need to run until the new time step.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">({</span>
            <span class="nx">runUntilTimeStep</span><span class="o">:</span> <span class="nx">newStepNum</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">frameChanged</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">isPaused</span><span class="p">()</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">mapView</span><span class="p">.</span><span class="nx">isStopped</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">getNextTimeStep</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">jumpToFirstFrame</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">setCurrentTimeStep</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Jump to the last LOADED frame of the animation. This will stop at</span>
<span class="cm">     whatever frame was the last received from the server.</span>

<span class="cm">     TODO: This should probably do something fancier, like block and load</span>
<span class="cm">     all of the remaining frames if they don&#39;t exist, until the end.</span>
<span class="cm">     */</span>
    <span class="nx">jumpToLastFrame</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">lastFrame</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">setCurrentTimeStep</span><span class="p">(</span><span class="nx">lastFrame</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">useFullscreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">switchToFullscreen</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sidebarEl</span><span class="p">).</span><span class="nx">hide</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">disableFullscreen</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">mapControlView</span><span class="p">.</span><span class="nx">switchToNormalScreen</span><span class="p">();</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sidebarEl</span><span class="p">).</span><span class="nx">show</span><span class="p">(</span><span class="s1">&#39;slow&#39;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="cm">/*</span>
<span class="cm">     Show the `ModalFormView` for the active tree item.</span>

<span class="cm">     If showing an add form, display the `ModalFormView` for the active node.</span>

<span class="cm">     If showing an edit form, perform a `fetch` using the `AjaxForm` for the</span>
<span class="cm">     selected node first, which will trigger the bound `ModalFormView` to display.</span>

<span class="cm">     The distinction of &quot;add&quot; versus &quot;edit&quot; is made on whether or not the node</span>
<span class="cm">     has an `id` property with a non-null value.</span>
<span class="cm">     */</span>
    <span class="nx">showFormForActiveTreeItem</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">treeView</span><span class="p">.</span><span class="nx">getActiveItem</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">formView</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">formViews</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">form_type</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">formView</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">formView</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">formView</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">},</span>

    <span class="nx">addButtonClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showFormForActiveTreeItem</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">treeItemDoubleClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showFormForActiveTreeItem</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">settingsButtonClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">showFormForActiveTreeItem</span><span class="p">();</span>
    <span class="p">},</span>

    <span class="nx">removeButtonClicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">treeView</span><span class="p">.</span><span class="nx">getActiveItem</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">form_type</span> <span class="o">||</span> <span class="o">!</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">form_type</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">confirm</span><span class="p">(</span><span class="s1">&#39;Remove &#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">submit</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ajaxForm</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">form_type</span> <span class="o">+</span> <span class="s1">&#39;/delete&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="s2">&quot;mover_id=&quot;</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Could not remove item.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>

    <span class="nx">moverChosen</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">moverType</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">formView</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">formViews</span><span class="p">[</span><span class="nx">moverType</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">formView</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">formView</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>


<span class="nb">window</span><span class="p">.</span><span class="nx">noaa</span><span class="p">.</span><span class="nx">erd</span><span class="p">.</span><span class="nx">gnome</span><span class="p">.</span><span class="nx">AppView</span> <span class="o">=</span> <span class="nx">AppView</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 